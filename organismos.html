<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Organismos</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
  
  <style>
    /* Variables CSS */
    :root {
        --primary-blue: #007bff;
        --primary-light-blue: #e7f4ff;
        --primary-dark-blue: #0056b3;
        --secondary-gray: #f8f9fa;
        --secondary-light-gray: #e9ecef;
        --secondary-dark-gray: #6c757d;
        --status-success: #28a745;
        --status-warning: #ffc107;
        --status-danger: #dc3545;
        --status-info: #17a2b8;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --text-link: #007bff;
        --text-light: #ffffff;
        --background-default: #ffffff;
        --background-card: #ffffff;
        --background-header: #ffffff;
        --background-table-header: #f8f9fa;
        --border-default: #dee2e6;
        --font-family: 'Arial', 'Helvetica', sans-serif;
        --display-size: 24px;
        --h1-size: 20px;
        --h2-size: 18px;
        --body-large-size: 16px;
        --body-regular-size: 14px;
        --caption-size: 12px;
        --font-weight-regular: 400;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        --spacing-unit: 8px;
        --spacing-xs: 4px;
        --spacing-s: 8px;
        --spacing-m: 16px;
        --spacing-l: 24px;
        --spacing-xl: 32px;
        --spacing-gutter: 20px;
        --border-radius-small: 2px;
        --border-radius-default: 4px;
        --border-radius-pill: 20px;
        --shadow-none: none;
        --shadow-subtle: 0 1px 3px rgba(0,0,0,0.1);
        --radius: 12px;
        --shadow: 0 4px 15px rgba(0,0,0,.08);
    }

    /* Estilos base */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--background-default);
        color: var(--text-primary);
        line-height: 1.5;
        min-height: 100vh;
    }

    /* Header */
    .header {
        background-color: var(--background-header);
        border-bottom: 1px solid var(--border-default);
        padding: var(--spacing-s) var(--spacing-m);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-subtle);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
    }

    .logo {
        font-size: var(--h1-size);
        font-weight: var(--font-weight-bold);
        color: var(--primary-blue);
    }

    /* Contenedor principal */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-m) var(--spacing-gutter);
    }

    /* Filtros */
    .filters-section {
        background-color: var(--background-card);
        padding: var(--spacing-m);
        border-radius: var(--border-radius-default);
        border: 1px solid var(--border-default);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-subtle);
    }

    .filters-title {
        font-size: var(--h2-size);
        font-weight: var(--font-weight-semibold);
        margin-bottom: var(--spacing-m);
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-m);
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-label {
        display: block;
        font-size: var(--body-regular-size);
        margin-bottom: var(--spacing-xs);
        font-weight: var(--font-weight-semibold);
    }

    .input, .dropdown {
        border: 1px solid var(--border-default);
        border-radius: var(--border-radius-default);
        padding: var(--spacing-s);
        background-color: var(--background-default);
        color: var(--text-primary);
        font-size: var(--body-regular-size);
        width: 100%;
        transition: border-color 0.2s;
    }

    .input:focus, .dropdown:focus {
        outline: none;
        border-color: var(--primary-blue);
    }

    /* Botones de acci贸n */
    .action-buttons {
        display: flex;
        gap: var(--spacing-s);
        margin-top: var(--spacing-m);
        flex-wrap: wrap;
    }

    .button {
        background-color: var(--primary-blue);
        color: var(--text-light);
        border: none;
        border-radius: var(--border-radius-default);
        padding: var(--spacing-s) var(--spacing-m);
        font-size: var(--body-regular-size);
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .button:hover {
        opacity: 0.9;
    }

    .button-success {
        background-color: #1e7e34;
    }

    .button-secondary {
        background-color: var(--secondary-dark-gray);
    }

    /* Tabla de datos - Estilo moderno */
    .table-section {
        background-color: var(--background-card);
        border-radius: var(--border-radius-default);
        border: 1px solid var(--border-default);
        overflow: hidden;
        box-shadow: var(--shadow-subtle);
        margin-bottom: var(--spacing-m);
    }

    .table-title {
        font-size: var(--h2-size);
        font-weight: var(--font-weight-semibold);
        padding: var(--spacing-m);
        background-color: var(--background-table-header);
        border-bottom: 1px solid var(--border-default);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-wrap {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .data-table th {
        background-color: var(--primary-blue);
        color: var(--text-light);
        font-weight: var(--font-weight-semibold);
        padding: var(--spacing-m);
        font-size: var(--caption-size);
        text-transform: uppercase;
        text-align: left;
        position: sticky;
        top: 0;
    }

    .data-table td {
        border-bottom: 1px solid var(--border-default);
        padding: var(--spacing-m);
        color: var(--text-primary);
        font-size: var(--body-regular-size);
        transition: background-color 0.2s;
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    .data-table tr:hover td {
        background-color: var(--primary-light-blue);
    }

    .data-table tr:nth-child(even) {
        background-color: var(--secondary-gray);
    }

    .data-table tr:nth-child(even):hover td {
        background-color: var(--primary-light-blue);
    }

    .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    /* Paginaci贸n */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-m);
        margin-top: var(--spacing-m);
        background: var(--background-card);
        border-radius: var(--border-radius-default);
        box-shadow: var(--shadow-subtle);
    }

    .pagination-container .page-info {
        font-size: var(--body-regular-size);
        color: var(--text-secondary);
        font-weight: var(--font-weight-semibold);
    }

    .pagination-container .nav-buttons {
        display: flex;
        gap: var(--spacing-s);
    }

    .pagination-selector {
        display: flex;
        align-items: center;
        gap: var(--spacing-s);
    }

    .pagination-selector select {
        padding: var(--spacing-s);
        border-radius: var(--border-radius-default);
        border: 1px solid var(--border-default);
    }

    /* MODALES */
    #organismModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.6);
        justify-content: center;
        align-items: center;
        padding: 20px;
        z-index: 1000;
    }
    
    #organismModal .content {
        background: #fff;
        border-radius: 16px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        animation: fadeIn .25s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
        position: sticky;
        top: 0;
        background: var(--primary-blue);
        color: #fff;
        padding: 12px 16px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 16px 16px 0 0;
        z-index: 5;
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
    }
    
    .modal-body {
        padding: 16px;
        overflow-y: auto;
    }
    
    .controls-form {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: 12px 16px;
        border-top: 1px solid #eee;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
        z-index: 5;
    }

    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 0.9rem;
        margin-bottom: 4px;
        display: block;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 0.9rem;
        background: #fafafa;
        transition: .2s;
    }
    
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
        outline: none;
        border-color: var(--primary-blue);
        background: #fff;
    }
    
    .field.error input,
    .field.error textarea,
    .field.error select {
        border-color: var(--status-danger);
        background-color: #ffeef0;
    }
    
    .field .error-message {
        color: var(--status-danger);
        font-size: 0.8rem;
        margin-top: 4px;
        display: none;
    }
    
    .field.error .error-message {
        display: block;
    }

    /* ALERTA FLOTANTE */
    .floating-alert {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--status-danger);
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        max-width: 400px;
        text-align: center;
        font-size: 1rem;
    }
    
    .floating-alert.success {
        background-color: var(--status-success);
    }

    .floating-alert.show {
        opacity: 1;
        visibility: visible;
        top: 20px;
    }

    /* Estados vac铆os */
    .empty-state {
        padding: 20px;
        text-align: center;
        font-weight: bold;
        color: var(--text-secondary);
        background: var(--secondary-light-gray);
        border-radius: 6px;
        margin: 10px 0;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .container {
            max-width: 100%;
            padding: var(--spacing-s);
        }
        
        .filter-row {
            gap: var(--spacing-s);
        }
        
        .filter-group {
            min-width: 180px;
        }

        #organismModal .content {
            max-width: 95%;
        }
    }

    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            gap: var(--spacing-s);
            text-align: center;
        }
        
        .filter-row {
            flex-direction: column;
        }
        
        .filter-group {
            min-width: auto;
        }
        
        .action-buttons {
            flex-direction: column;
        }

        .controls-form {
            flex-direction: column;
        }
        
        .pagination-container {
            flex-direction: column;
            gap: var(--spacing-m);
            text-align: center;
        }
    }

    @media (max-width: 576px) {
        .container {
            padding: var(--spacing-xs);
        }
        
        .filters-section,
        .table-section {
            padding: var(--spacing-s);
        }
        
        .filters-title,
        .table-title {
            font-size: var(--body-large-size);
        }

        #organismModal .content {
            max-width: 100%;
            max-height: 100vh;
            border-radius: 0;
        }

        .modal-header,
        .modal-body,
        .controls-form {
            padding: var(--spacing-s);
        }
        
        .actions {
            flex-direction: column;
        }
        
        .data-table {
            min-width: 600px;
        }
    }
  </style>
</head>
<body>
    <!-- Alerta flotante -->
    <div class="floating-alert" id="floating-alert"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">Directorio de Organismos</div>
            <button id="btnNuevo" class="button">
                <i class="fas fa-plus"></i> Nuevo Organismo
            </button>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="container">
        <!-- Filtros -->
        <section class="filters-section">
            <h2 class="filters-title">Filtros de B煤squeda</h2>
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" for="buscador">B煤squeda</label>
                    <input type="text" id="buscador" class="input" placeholder=" Buscar...">
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="filtroTipo">Tipo de Organismo</label>
                    <select id="filtroTipo" class="dropdown">
                        <option value="">Tipo (todos)</option>
                        <option>Hospital</option>
                        <option>Ministerio</option>
                        <option>Centro Asistencial</option>
                        <option>Unidad de Traslado</option>
                        <option>Direcci贸n Gubernamental</option>
                        <option>Fundaci贸n</option>
                        <option>Otro</option>
                    </select>
                </div>
            </div>
            
            <!-- Botones de impresi贸n -->
            <div class="action-buttons">
                <button id="btnPrintListado" class="button button-success">
                    <i class="fas fa-print"></i> Imprimir Listado
                </button>
            </div>
        </section>

        <!-- Controles de paginaci贸n superiores -->
        <div id="paginacion-superior" class="pagination-container">
            <div class="page-info" id="pageInfoTop">Mostrando 0 de 0 registros</div>
            <div class="pagination-selector">
                <div class="nav-buttons">
                    <button id="btnPrevPageTop" class="button" disabled>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button id="btnNextPageTop" class="button" disabled>
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <select id="pageSelectTop" class="dropdown">
                    <option value="1">P谩gina 1</option>
                </select>
            </div>
        </div>

        <!-- Tabla de datos -->
        <section class="table-section">
            <div class="table-title">
                <span>Organismos</span>
                <span id="tableCount">Total: 0</span>
            </div>
            <div class="table-wrap">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Email</th>
                            <th>Tel茅fono</th>
                            <th>Contacto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="organismsTableBody">
                        <tr>
                            <td colspan="6">Cargando organismos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Controles de paginaci贸n inferiores -->
        <div id="paginacion-inferior" class="pagination-container">
            <div class="page-info" id="pageInfoBottom">Mostrando 0 de 0 registros</div>
            <div class="pagination-selector">
                <div class="nav-buttons">
                    <button id="btnPrevPageBottom" class="button" disabled>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button id="btnNextPageBottom" class="button" disabled>
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <select id="pageSelectBottom" class="dropdown">
                    <option value="1">P谩gina 1</option>
                </select>
            </div>
        </div>
    </main>

    <!-- Modal para nuevo/editar organismo -->
    <div id="organismModal">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-building"></i>
                <h2 id="modalTitle" style="margin:0;">Nuevo Organismo</h2>
            </div>
            <div class="modal-body">
                <form id="organismForm" action="#" method="post" aria-label="Formulario para nuevo organismo o edici贸n">
                    <div class="form-group">
                        <label for="nombre">Nombre *</label>
                        <input id="nombre" required autocomplete="off" />
                        <span class="error-message">Este campo es obligatorio.</span>
                    </div>
                    <div class="form-group">
                        <label for="tipo">Tipo *</label>
                        <select id="tipo" required>
                            <option value="">Seleccionar...</option>
                            <option>Hospital</option>
                            <option>Ministerio</option>
                            <option>Centro Asistencial</option>
                            <option>Unidad de Traslado</option>
                            <option>Direcci贸n Gubernamental</option>
                            <option>Fundaci贸n</option>
                            <option>Otro</option>
                        </select>
                        <span class="error-message">Este campo es obligatorio.</span>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input id="email" type="email" />
                    </div>
                    <div class="form-group">
                        <label for="telefono">Tel茅fono</label>
                        <input id="telefono" />
                    </div>
                    <div class="form-group">
                        <label for="contacto">Contacto</label>
                        <input id="contacto" />
                    </div>
                    <div class="form-group">
                        <label for="notas">Notas</label>
                        <textarea id="notas" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="controls-form">
                <button class="button button-success" type="button" id="btnGuardar">
                    <i class="fa fa-save"></i> Guardar
                </button>
                <button class="button button-secondary" type="button" id="btnCancelar">
                    <i class="fa fa-xmark"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== Configuraci贸n de Firebase =====
        const firebaseConfig = {
            apiKey: "AIzaSyCpPdY984mCYWQodeqA6ZVXFxedalExc34",
            authDomain: "repositorio-documentos.firebaseapp.com",
            databaseURL: "https://repositorio-documentos-default-rtdb.firebaseio.com",
            projectId: "repositorio-documentos",
            storageBucket: "repositorio-documentos.firebasestorage.app",
            messagingSenderId: "359488594361",
            appId: "1:359488594361:web:421264bbc3c5f8f7c01668"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const organismsRef = db.ref('organismos');

        // ===== Helpers UI =====
        const $ = (id) => document.getElementById(id);
        const tbody = $("organismsTableBody");
        const modal = $("organismModal");
        const modalTitle = $("modalTitle");
        const buscador = $("buscador");
        const filtroTipo = $("filtroTipo");
        const floatingAlert = $("floating-alert");
        const tableCount = $("tableCount");

        // ===== Variables de estado =====
        let editingId = null;
        let allOrganisms = [];
        let filteredOrganisms = [];
        let paginaActual = 1;
        const registrosPorPagina = 10;

        // Organismos iniciales para precarga
        const initialOrganisms = [
            {nombre:"Hospital Barreyro",tipo:"Hospital",email:"hospitaldepediatriabarreyro@gmail.com",telefono:"",contacto:"",notas:""},
            {nombre:"Hospital Carrillo",tipo:"Hospital",email:"hospitalsaludmentalcarrillo@gmail.com",telefono:"",contacto:"",notas:""},
            {nombre:"Ministerio de Salud P煤blica de Misiones",tipo:"Ministerio",email:"juridicomspmisiones@gmail.com",telefono:"",contacto:"",notas:"Para compartir oficios dirigidos a cualquier Hospital"},
            {nombre:"Centro Asistencial",tipo:"Centro Asistencial",email:"",telefono:"+5493755636878",contacto:"Jordana Duarte Martinelli",notas:"Encargada de recibir oficios"},
            {nombre:"Unidad Central de Traslado",tipo:"Unidad de Traslado",email:"mps-uct@hotmail.com",telefono:"",contacto:"",notas:""},
            {nombre:"Direcci贸n de Asuntos de Familia",tipo:"Direcci贸n Gubernamental",email:"",telefono:"+5493764856048",contacto:"",notas:""},
            {nombre:"Fundaci贸n Reto a la vida",tipo:"Fundaci贸n",email:"retomisiones@gmail.com",telefono:"",contacto:"",notas:""}
        ];

        // ===== Funciones de utilidad =====
        const escapeHtml = (s) => {
            return String(s || '').replace(/[&<>"']/g, m => 
                ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        };

        const mostrarAlertaFlotante = (mensaje, tipo) => {
            floatingAlert.textContent = mensaje;
            floatingAlert.classList.remove('danger', 'success');
            floatingAlert.classList.add(tipo);
            floatingAlert.classList.add('show');
            setTimeout(() => {
                floatingAlert.classList.remove('show');
            }, 3000);
        };

        // ===== Funciones de validaci贸n =====
        function validateForm() {
            let isValid = true;
            const requiredFields = ["nombre", "tipo"];
            
            requiredFields.forEach(id => {
                const field = $(id);
                const parent = field.closest('.form-group');
                if (field.value.trim() === "") {
                    parent.classList.add('error');
                    isValid = false;
                } else {
                    parent.classList.remove('error');
                }
            });

            return isValid;
        }

        // ===== Funciones de paginaci贸n =====
        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(filteredOrganisms.length / registrosPorPagina);
            const inicio = (paginaActual - 1) * registrosPorPagina + 1;
            const fin = Math.min(paginaActual * registrosPorPagina, filteredOrganisms.length);
            const total = filteredOrganisms.length;
            
            // Actualizar informaci贸n de p谩gina
            const pageInfoText = `Mostrando ${inicio}-${fin} de ${total} registros`;
            $("pageInfoTop").textContent = pageInfoText;
            $("pageInfoBottom").textContent = pageInfoText;
            
            // Actualizar selectores de p谩gina
            const pageSelectTop = $("pageSelectTop");
            const pageSelectBottom = $("pageSelectBottom");
            
            pageSelectTop.innerHTML = '';
            pageSelectBottom.innerHTML = '';
            
            for (let i = 1; i <= totalPaginas; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `P谩gina ${i}`;
                if (i === paginaActual) {
                    option.selected = true;
                }
                pageSelectTop.appendChild(option.cloneNode(true));
                pageSelectBottom.appendChild(option);
            }
            
            // Actualizar estado de botones
            const prevButtons = [$("btnPrevPageTop"), $("btnPrevPageBottom")];
            const nextButtons = [$("btnNextPageTop"), $("btnNextPageBottom")];
            
            prevButtons.forEach(btn => {
                btn.disabled = paginaActual === 1;
            });
            
            nextButtons.forEach(btn => {
                btn.disabled = paginaActual === totalPaginas;
            });
            
            // Actualizar contador de tabla
            tableCount.textContent = `Total: ${total}`;
        }

        function cambiarPagina(nuevaPagina) {
            const totalPaginas = Math.ceil(filteredOrganisms.length / registrosPorPagina);
            
            if (nuevaPagina < 1 || nuevaPagina > totalPaginas) {
                return;
            }
            
            paginaActual = nuevaPagina;
            renderTable();
            actualizarPaginacion();
        }

        // ===== Funciones de renderizado =====
        function renderTable() {
            const inicio = (paginaActual - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const organismsToShow = filteredOrganisms.slice(inicio, fin);
            
            tbody.innerHTML = '';
            
            if (organismsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">No hay organismos que coincidan con los filtros</div>
                        </td>
                    </tr>`;
                return;
            }
            
            organismsToShow.forEach(organism => {
                const emailLink = organism.email ? 
                    `<a href='mailto:${escapeHtml(organism.email)}'>${escapeHtml(organism.email)}</a>` : 
                    '-';
                
                const telefonoLink = organism.telefono ? 
                    `<a href='tel:${escapeHtml(organism.telefono)}'>${escapeHtml(organism.telefono)}</a>` : 
                    '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(organism.nombre)}</td>
                    <td>${escapeHtml(organism.tipo)}</td>
                    <td>${emailLink}</td>
                    <td>${telefonoLink}</td>
                    <td>${escapeHtml(organism.contacto || '-')}</td>
                    <td class="actions">
                        <button class="button button-secondary editar-organismo" data-id="${organism.id}" title="Editar">
                            <i class="fa fa-pen"></i> Editar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Asignar eventos a los botones
            document.querySelectorAll(".editar-organismo").forEach(btn => {
                btn.onclick = () => abrirEditar(btn.dataset.id);
            });
        }

        // ===== Funciones de filtrado =====
        function filtrarOrganismos() {
            const q = (buscador.value || "").toLowerCase();
            const tipo = (filtroTipo.value || "").toLowerCase();
            
            filteredOrganisms = allOrganisms.filter(organism => {
                const okTexto = !q || 
                    organism.nombre.toLowerCase().includes(q) || 
                    organism.tipo.toLowerCase().includes(q) ||
                    (organism.contacto && organism.contacto.toLowerCase().includes(q)) ||
                    (organism.notas && organism.notas.toLowerCase().includes(q));
                
                const okTipo = !tipo || organism.tipo.toLowerCase() === tipo;
                
                return okTexto && okTipo;
            });
            
            // Resetear a la primera p谩gina despu茅s de filtrar
            paginaActual = 1;
            renderTable();
            actualizarPaginacion();
        }

        // ===== Funciones CRUD =====
        function abrirNuevo() {
            editingId = null;
            modalTitle.textContent = "Nuevo Organismo";
            $("organismForm").reset();
            
            // Limpiar errores de validaci贸n
            document.querySelectorAll('.form-group.error').forEach(el => {
                el.classList.remove('error');
            });
            
            modal.style.display = "flex";
        }

        function abrirEditar(id) {
            editingId = id;
            modalTitle.textContent = "Editar Organismo";
            
            const organism = allOrganisms.find(o => o.id === id);
            if (organism) {
                $("nombre").value = organism.nombre || "";
                $("tipo").value = organism.tipo || "";
                $("email").value = organism.email || "";
                $("telefono").value = organism.telefono || "";
                $("contacto").value = organism.contacto || "";
                $("notas").value = organism.notas || "";
                
                // Limpiar errores de validaci贸n
                document.querySelectorAll('.form-group.error').forEach(el => {
                    el.classList.remove('error');
                });
                
                modal.style.display = "flex";
            } else {
                mostrarAlertaFlotante("Organismo no encontrado", "danger");
            }
        }

        async function guardarOrganismo() {
            if (!validateForm()) {
                mostrarAlertaFlotante("Por favor, completa los campos obligatorios", "danger");
                return;
            }
            
            const datos = {
                nombre: $("nombre").value.trim(),
                tipo: $("tipo").value.trim(),
                email: $("email").value.trim(),
                telefono: $("telefono").value.trim(),
                contacto: $("contacto").value.trim(),
                notas: $("notas").value.trim()
            };
            
            try {
                if (editingId) {
                    await organismsRef.child(editingId).update(datos);
                    mostrarAlertaFlotante("Organismo actualizado correctamente", "success");
                } else {
                    await organismsRef.push(datos);
                    mostrarAlertaFlotante("Organismo creado correctamente", "success");
                }
                
                modal.style.display = "none";
            } catch (error) {
                console.error("Error al guardar organismo:", error);
                mostrarAlertaFlotante("Error al guardar el organismo", "danger");
            }
        }

        // ===== Funciones de impresi贸n =====
        function printListado() {
            const head = tbody.closest("table").querySelector("thead").outerHTML;
            const body = tbody.outerHTML;
            const w = window.open("", "_blank", "width=900,height=700");
            w.document.write(`
                <html>
                    <head>
                        <title>Directorio de Organismos</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
                            th { background-color: #007bff; color: white; }
                            tr:nth-child(even) { background-color: #f8f9fa; }
                        </style>
                    </head>
                    <body>
                        <h1>Directorio de Organismos</h1>
                        <table>${head}${body}</table>
                    </body>
                </html>
            `);
            w.document.close();
            w.focus();
            w.print();
        }

        // ===== Inicializaci贸n =====
        function initApp() {
            // Precargar datos iniciales si la base de datos est谩 vac铆a
            organismsRef.once('value', snap => {
                if (!snap.exists()) {
                    initialOrganisms.forEach(organism => {
                        organismsRef.push(organism);
                    });
                }
            });

            // Escuchar cambios en la base de datos
            organismsRef.on('value', snap => {
                const data = snap.val() || {};
                allOrganisms = Object.entries(data).map(([id, value]) => ({
                    id,
                    ...value
                }));
                
                filtrarOrganismos();
            });

            // Asignar eventos
            $("btnNuevo").onclick = abrirNuevo;
            $("btnGuardar").onclick = guardarOrganismo;
            $("btnCancelar").onclick = () => modal.style.display = "none";
            $("btnPrintListado").onclick = printListado;
            
            // Eventos de filtrado
            buscador.oninput = filtrarOrganismos;
            filtroTipo.onchange = filtrarOrganismos;
            
            // Eventos de paginaci贸n superiores
            $("btnPrevPageTop").onclick = () => cambiarPagina(paginaActual - 1);
            $("btnNextPageTop").onclick = () => cambiarPagina(paginaActual + 1);
            $("pageSelectTop").onchange = (e) => cambiarPagina(parseInt(e.target.value));
            
            // Eventos de paginaci贸n inferiores
            $("btnPrevPageBottom").onclick = () => cambiarPagina(paginaActual - 1);
            $("btnNextPageBottom").onclick = () => cambiarPagina(paginaActual + 1);
            $("pageSelectBottom").onchange = (e) => cambiarPagina(parseInt(e.target.value));

            // Cerrar modal al hacer clic fuera
            window.addEventListener("click", e => {
                if (e.target === modal) {
                    modal.style.display = "none";
                }
            });
        }

        // Inicializar la aplicaci贸n cuando el DOM est茅 listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>