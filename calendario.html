<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-page: #F8F9FA;
      --bg-content: #FFFFFF;
      --bg-input: #F4F5F7;
      --border: #E9ECEF;
      --text-primary: #212529;
      --text-secondary: #6C757D;
      --accent-blue: #0D6EFD;
      --success: #198754;
      /* Colores por tipo de evento */
      --color-audiencia: #D1F2E9; /* Verde suave */
      --color-gesel: #FFEADD;     /* Naranja suave */
      --color-vencimiento: #FFD6D6; /* Rojo suave */
      --color-recurso: #E8DAFF;   /* Violeta suave */
      --event-day-bg: #F0F7FF;
      --radius: 12px;
      --space: 16px;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: var(--bg-page);
      color: var(--text-primary);
      padding: var(--space);
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .main-panel {
      flex: 1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .nav-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-btn {
      background: white;
      border: 1px solid var(--border);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
    }

    .nav-btn.today {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
      width: auto;
      padding: 0 12px;
    }

    .filters {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }

    .search-container {
      position: relative;
    }

    .search-btn {
      background: white;
      border: 1px solid var(--border);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-secondary);
    }

    .search-input {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      width: 200px;
      display: none;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .search-input.active {
      display: block;
    }

    .btn-print {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-print:hover {
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }


    /* Calendario principal */
    .calendar-view {
      background: var(--bg-content);
      border-radius: var(--radius);
      margin-top: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .month-label {
      padding: 16px 24px;
      font-size: 20px;
      font-weight: 700;
      background: #fafafa;
      border-bottom: 1px solid var(--border);
    }

    /* Vista Mes */
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      padding: 1px;
    }

    .month-day {
      background: white;
      min-height: 100px;
      padding: 8px;
      position: relative;
    }

    .month-day-header {
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: flex-end;
    }

    .month-day.other-month {
      background: #f8f9fa;
      color: var(--text-secondary);
    }

    .month-event {
      display: block;
      padding: 4px;
      margin-top: 4px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .month-event.audiencia { background: var(--color-audiencia); }
    .month-event.gesel { background: var(--color-gesel); }
    .month-event.vencimiento { background: var(--color-vencimiento); }
    .month-event.recurso { background: var(--color-recurso); }


    /* Modal de detalles de causa */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
      width: 450px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h3 {
      margin-bottom: 10px;
      color: var(--accent-blue);
    }

    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }

    .btn-print-modal {
      margin-top: 12px;
      background: var(--accent-blue);
      color: #fff;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: .9rem;
    }

    .btn-print-modal:hover {
      opacity: .9;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left, .header-right {
        width: 100%;
        justify-content: space-between;
      }
      .nav-controls {
        width: 100%;
        justify-content: space-between;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      .month-day {
        min-height: 80px;
      }
    }

    @media (max-width: 480px) {
      /* Estilos responsivos simplificados */
    }

    /* Estilos para impresi√≥n */
    @media print {
      body * {
        visibility: hidden;
      }
      .print-content, .print-content * {
        visibility: visible;
      }
      .print-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-panel">
      <div class="header">
        <div class="header-left">
          
          <div class="nav-controls">
            <button class="nav-btn" id="prevBtn">‚Äπ</button>
            <button class="nav-btn today" id="todayBtn">Hoy</button>
            <button class="nav-btn" id="nextBtn">‚Ä∫</button>
            
            <div class="filters">
              <select id="filterTipo" class="filter-select">
                <option value="">Todos</option>
                <option value="Audiencia">Audiencias</option>
                <option value="C√°mara Gesell">C√°mara Gesell</option>
                <option value="Vencimiento">Vencimientos</option>
                <option value="Vencimiento Recurso">Vencimientos Recurso</option>
              </select>
            </div>
            
            <div class="search-container">
              <button class="search-btn" id="searchBtn">üîç</button>
              <input type="text" class="search-input" id="searchInput" placeholder="Buscar eventos..." />
            </div>

            <button class="btn-print" id="btnPrintView">
              üñ®Ô∏è Imprimir Vista
            </button>
          </div>
        </div>
      </div>

      <div class="calendar-view">
        <div class="month-label" id="mainMonthLabel">Junio 2024</div>
        <div id="calendarContent"></div>
      </div>
    </div>

  </div>

  <div id="modalCausa" class="modal hidden">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h3>Detalle de la Causa</h3>
      <div id="modalBody"></div>
      <button id="btnPrintCausa" class="btn-print-modal">üñ®Ô∏è Imprimir Causa</button>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
      authDomain: "causas-defensoria.firebaseapp.com",
      projectId: "causas-defensoria",
      storageBucket: "causas-defensoria.firebasestorage.app",
      messagingSenderId: "186064671470",
      appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Estado
    let currentDate = new Date();
    const currentView = 'month'; // 'day', 'week', 'month' -> Solo se usa 'month'
    let events = [];
    let causasMap = {};
    let currentCausaId = null;
    const monthNames = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];

    // Feriados
    const feriados = {
      "01-01":"A√±o Nuevo","24-03":"D√≠a de la Memoria","02-04":"Malvinas y Ca√≠dos","01-05":"D√≠a del Trabajador",
      "25-05":"D√≠a de la Patria","20-06":"Paso a la Inmortalidad de Belgrano","09-07":"Independencia","17-08":"San Mart√≠n",
      "10-10":"Feriado","12-10":"Diversidad Cultural","17-11":"Feriado- D√≠a del Empleado Judicial", "21-11":"Soberan√≠a Nacional", 
      "24-11":"Soberan√≠a Nacional","08-12":"Inmaculada Concepci√≥n","25-12":"Navidad"
    };

    // DOM
    const mainMonthLabel = document.getElementById('mainMonthLabel');
    const calendarContent = document.getElementById('calendarContent');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const todayBtn = document.getElementById('todayBtn');
    const filterTipo = document.getElementById('filterTipo');
    const modalCausa = document.getElementById('modalCausa');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');
    const btnPrintCausa = document.getElementById('btnPrintCausa');
    const btnPrintView = document.getElementById('btnPrintView');
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      loadEventsFromFirebase();
    });

    // Cargar eventos desde Firebase
    function loadEventsFromFirebase() {
      db.collection("causas").onSnapshot((querySnapshot) => {
        events = [];
        causasMap = {};
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const id = data.numCausa || doc.id;
          causasMap[id] = data;
          
          // Funci√≥n para procesar fechas (individuales o arrays)
          const procesarFechas = (fechaData, tipo) => {
            if (!fechaData) return;
            
            // Si es un array de audiencias
            if (Array.isArray(fechaData)) {
              fechaData.forEach(fecha => {
                if (!fecha) return;
                const f = fecha.seconds ? new Date(fecha.seconds * 1000) : new Date(fecha);
                if (!isNaN(f)) {
                  // Crear un evento para cada fecha
                  const eventType = tipo === "Audiencia" ? "audiencia" : 
                                  tipo === "C√°mara Gesell" ? "gesel" : 
                                  tipo === "Vencimiento Recurso" ? "recurso" : "vencimiento";
                  
                  events.push({
                    id: `${id}-${tipo}-${f.getTime()}`,
                    title: `${tipo} - Causa N¬∫ ${id}`,
                    type: eventType,
                    date: formatDate(f),
                    start: formatTime(f),
                    end: calculateEndTime(f),
                    causaId: id,
                    fechaCompleta: f,
                    tipoOriginal: tipo
                  });
                }
              });
            } 
            // Si es una fecha individual (formato antiguo)
            else {
              const f = fechaData.seconds ? new Date(fechaData.seconds * 1000) : new Date(fechaData);
              if (!isNaN(f)) {
                const eventType = tipo === "Audiencia" ? "audiencia" : 
                                tipo === "C√°mara Gesell" ? "gesel" : 
                                tipo === "Vencimiento Recurso" ? "recurso" : "vencimiento";
                
                events.push({
                  id: `${id}-${tipo}`,
                  title: `${tipo} - Causa N¬∫ ${id}`,
                  type: eventType,
                  date: formatDate(f),
                  start: formatTime(f),
                  end: calculateEndTime(f),
                  causaId: id,
                  fechaCompleta: f,
                  tipoOriginal: tipo
                });
              }
            }
          };
          
          // Procesar todos los tipos de eventos
          procesarFechas(data.audiencias, "Audiencia");
          procesarFechas(data.audienciaGesell, "C√°mara Gesell");
          procesarFechas(data.vencimiento, "Vencimiento");
          procesarFechas(data.vencimientoRecursos, "Vencimiento Recurso");
        });
        
        renderAll();
      }, (error) => {
        console.error("Error cargando causas:", error);
        // Datos de ejemplo si no hay conexi√≥n a Firebase
        events = [
          {
            id: 1,
            title: "Audiencia Penal - Causa N¬∫ 12345",
            type: "audiencia",
            tipoOriginal: "Audiencia",
            date: formatDate(new Date()),
            start: "09:00",
            end: "10:00",
            causaId: "12345",
            fechaCompleta: new Date()
          },
          {
            id: 2,
            title: "Vencimiento de recurso - Causa N¬∫ 67890",
            type: "recurso",
            tipoOriginal: "Vencimiento Recurso",
            date: formatDate(new Date()),
            start: "14:30",
            end: "15:30",
            causaId: "67890",
            fechaCompleta: new Date()
          },
          {
            id: 3,
            title: "Audiencia Gesell - Causa N¬∫ 54321",
            type: "gesel",
            tipoOriginal: "C√°mara Gesell",
            date: formatDate(new Date(new Date().setDate(new Date().getDate() + 3))),
            start: "11:00",
            end: "12:00",
            causaId: "54321",
            fechaCompleta: new Date(new Date().setDate(new Date().getDate() + 3))
          }
        ];
        renderAll();
      });
    }

    function setupEventListeners() {
      // Navegaci√≥n (simplificada para solo mes)
      prevBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderAll();
      });

      nextBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderAll();
      });

      todayBtn.addEventListener('click', () => {
        currentDate = new Date();
        renderAll();
      });

      // B√∫squeda
      let isSearchOpen = false;
      searchBtn.addEventListener('click', () => {
        isSearchOpen = !isSearchOpen;
        searchInput.classList.toggle('active', isSearchOpen);
        if (isSearchOpen) searchInput.focus();
      });
      document.addEventListener('click', (e) => {
        if (!searchBtn.contains(e.target) && !searchInput.contains(e.target)) {
          searchInput.classList.remove('active');
        }
      });
      searchInput.addEventListener('input', renderAll);

      // Filtro por tipo
      filterTipo.addEventListener('change', renderAll);

      // Modal
      closeModal.addEventListener('click', () => {
        modalCausa.classList.add('hidden');
      });
      
      window.addEventListener('click', (e) => {
        if (e.target === modalCausa) {
          modalCausa.classList.add('hidden');
        }
      });

      // Imprimir causa
      btnPrintCausa.addEventListener('click', () => {
        if (!currentCausaId) return;
        const html = `<h2>Causa N¬∫ ${currentCausaId}</h2>` + modalBody.innerHTML;
        const w = window.open("", "", "width=800,height=600");
        w.document.write(`<html><head><title>Causa ${currentCausaId}</title></head><body>${html}</body></html>`);
        w.document.close();
        w.focus();
        w.print();
      });

      // Imprimir vista actual
      btnPrintView.addEventListener('click', printCurrentView);
    }

    // Funci√≥n para imprimir la vista actual
    function printCurrentView() {
      const filtered = getFilteredEvents();
      let printContent = '';
      const title = `Calendario - ${mainMonthLabel.textContent}`;
      const filterText = filterTipo.value ? ` - Filtro: ${filterTipo.options[filterTipo.selectedIndex].text}` : '';
      const searchText = searchInput.value ? ` - B√∫squeda: "${searchInput.value}"` : '';
      
      printContent += `<h1>${title}${filterText}${searchText}</h1>`;
      printContent += `<p>Vista: Mes</p>`;
      
      printContent += renderMonthViewForPrint(filtered);
      
      const w = window.open("", "", "width=900,height=700");
      w.document.write(`
        <html>
          <head>
            <title>${title}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { color: #0D6EFD; margin-bottom: 10px; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .event { margin-bottom: 5px; padding: 5px; border-radius: 4px; }
              .audiencia { background-color: #D1F2E9; }
              .gesel { background-color: #FFEADD; }
              .vencimiento { background-color: #FFD6D6; }
              .recurso { background-color: #E8DAFF; }
              .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
              .month-day { border: 1px solid #ddd; padding: 5px; min-height: 80px; }
              .month-day-header { font-weight: bold; margin-bottom: 5px; }
              .month-event { font-size: 10px; margin-top: 2px; padding: 2px; border-radius: 2px; }
            </style>
          </head>
          <body>
            <div class="print-content">
              ${printContent}
            </div>
          </body>
        </html>
      `);
      w.document.close();
      w.focus();
      w.print();
    }

    // Funciones para generar contenido para impresi√≥n
    function renderMonthViewForPrint(eventsList) {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay(); // 0 = dom
      const daysInMonth = lastDay.getDate();
      
      let html = `<h2>Vista del Mes: ${monthNames[month]} ${year}</h2>`;
      html += '<div class="month-grid">';
      
      // Encabezados
      const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      dayNames.forEach(name => {
        html += `<div class="month-day" style="text-align:center;font-weight:bold;background:#f2f2f2;">${name}</div>`;
      });

      // D√≠as del mes anterior
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay === 0 ? 6 : startDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="month-day" style="background:#f9f9f9;color:#999;">${day}</div>`;
      }

      // D√≠as del mes actual
      const todayStr = formatDate(new Date());
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDate(new Date(year, month, day));
        const isToday = dateStr === todayStr;
        const dayEvents = eventsList.filter(e => e.date === dateStr);

        let eventsHTML = '';
        dayEvents.forEach(e => {
          eventsHTML += `<div class="month-event ${e.type}">${e.title}</div>`;
        });

        html += `
          <div class="month-day" style="${isToday ? 'background:#e6f3ff;' : ''}">
            <div class="month-day-header">${day}</div>
            ${eventsHTML}
          </div>
        `;
      }

      // D√≠as del mes siguiente
      const totalCells = 42;
      const daysSoFar = startDay === 0 ? 6 + 1 : startDay + daysInMonth;
      const nextDays = totalCells - daysSoFar;
      for (let day = 1; day <= nextDays; day++) {
        html += `<div class="month-day" style="background:#f9f9f9;color:#999;">${day}</div>`;
      }

      html += '</div>';
      return html;
    }

    // Formatear fecha a DD/MM/AAAA
    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Formatear hora a HH:MM
    function formatTime(date) {
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // Calcular hora de finalizaci√≥n (1 hora despu√©s por defecto)
    function calculateEndTime(date) {
      const endDate = new Date(date);
      endDate.setHours(endDate.getHours() + 1);
      return formatTime(endDate);
    }

    // Convertir DD/MM/AAAA a objeto Date
    function parseDate(dateStr) {
      const [day, month, year] = dateStr.split('/').map(Number);
      return new Date(year, month - 1, day);
    }

    function getFilteredEvents() {
      const query = searchInput.value.trim().toLowerCase();
      const tipoFilter = filterTipo.value;
      
      return events.filter(e => {
        // Filtro por b√∫squeda de texto
        const matchesSearch = !query || 
          e.title.toLowerCase().includes(query) ||
          e.type.toLowerCase().includes(query) ||
          e.date.includes(query) ||
          e.start.includes(query);
        
        // Filtro por tipo
        let matchesTipo = true;
        if (tipoFilter) {
          matchesTipo = e.tipoOriginal === tipoFilter;
        }
        
        return matchesSearch && matchesTipo;
      });
    }

    function renderAll() {
      renderMainCalendar();
    }

    function renderMainCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      mainMonthLabel.textContent = `${monthNames[month]} ${year}`;

      const filtered = getFilteredEvents();

      renderMonthView(filtered);
    }

    function renderMonthView(eventsList) {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay(); // 0 = dom
      const daysInMonth = lastDay.getDate();

      let gridHTML = '';

      // Encabezados
      const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      dayNames.forEach(name => {
        gridHTML += `<div class="month-day-header" style="font-weight:700;text-align:center;background:#fafafa;padding:8px;">${name}</div>`;
      });

      // D√≠as del mes anterior
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = startDay === 0 ? 6 : startDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        gridHTML += `<div class="month-day other-month"><div class="month-day-header">${day}</div></div>`;
      }

      // D√≠as del mes actual
      const todayStr = formatDate(new Date());
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDate(new Date(year, month, day));
        const isToday = dateStr === todayStr;
        const dayEvents = eventsList.filter(e => e.date === dateStr);

        let eventsHTML = '';
        dayEvents.forEach(e => {
          eventsHTML += `<span class="month-event ${e.type}" data-causa-id="${e.causaId}">${e.title}</span>`;
        });

        gridHTML += `
          <div class="month-day ${isToday ? 'today' : ''}">
            <div class="month-day-header">${day}</div>
            ${eventsHTML}
          </div>
        `;
      }

      // D√≠as del mes siguiente
      const totalCells = 42;
      const daysSoFar = startDay === 0 ? 6 + 1 : startDay + daysInMonth;
      const nextDays = totalCells - daysSoFar;
      for (let day = 1; day <= nextDays; day++) {
        gridHTML += `<div class="month-day other-month"><div class="month-day-header">${day}</div></div>`;
      }

      calendarContent.innerHTML = `<div class="month-grid">${gridHTML}</div>`;
      
      // Agregar event listeners a los eventos para abrir el modal
      document.querySelectorAll('.month-event').forEach(event => {
        event.addEventListener('click', () => {
          const causaId = event.dataset.causaId;
          showCausaDetails(causaId);
        });
      });
    }

    function showCausaDetails(causaId) {
      const causa = causasMap[causaId];
      if (!causa) return;
      
      currentCausaId = causaId;
      let body = `<p><b>numCausa:</b> ${causaId}</p>`;
      for (const [key, value] of Object.entries(causa)) {
        let formattedValue = value;
        // Manejo de fechas y timestamps
        if (value && value.seconds) {
          // Si la clave es "fechaInicio", solo mostrar la fecha
          if (key === "fechaInicio") {
              formattedValue = new Date(value.seconds * 1000).toLocaleDateString("es-ES");
          } else {
              // Para otros timestamps, mostrar fecha y hora
              formattedValue = new Date(value.seconds * 1000).toLocaleString("es-ES");
          }
        }
        // Manejo de arrays, verificando cada elemento
        else if (Array.isArray(value)) {
          const formattedDates = value.map(item => {
            if (item && item.seconds) {
              return new Date(item.seconds * 1000).toLocaleString("es-ES");
            }
            return item;
          });
          formattedValue = formattedDates.join(", ");
        }
        body += `<p><b>${key}:</b> ${formattedValue ?? "-"}</p>`;
      }
      modalBody.innerHTML = body;
      modalCausa.classList.remove('hidden');
    }
  </script>
</body>
</html>