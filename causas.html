<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causas</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    <style>
        /* Variables CSS */
        :root {
            --primary-blue: #007bff;
            --primary-light-blue: #e7f4ff;
            --primary-dark-blue: #0056b3;
            --secondary-gray: #f8f9fa;
            --secondary-light-gray: #e9ecef;
            --secondary-dark-gray: #6c757d;
            --status-success: #28a745;
            --status-warning: #ffc107;
            --status-danger: #dc3545;
            --status-info: #17a2b8;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-link: #007bff;
            --text-light: #ffffff;
            --background-default: #ffffff;
            --background-card: #ffffff;
            --background-header: #ffffff;
            --background-table-header: #f8f9fa;
            --border-default: #dee2e6;
            --font-family: 'Arial', 'Helvetica', sans-serif;
            --display-size: 24px;
            --h1-size: 20px;
            --h2-size: 18px;
            --body-large-size: 16px;
            --body-regular-size: 14px;
            --caption-size: 12px;
            --font-weight-regular: 400;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --spacing-unit: 8px;
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-gutter: 20px;
            --border-radius-small: 2px;
            --border-radius-default: 4px;
            --border-radius-pill: 20px;
            --shadow-none: none;
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,.08);
            --color-audiencias: #007bff;
            --color-vencimientos: #dc3545;
            --color-gesell: #28a745;
            --color-recursos: #6f42c1;
        }
        /* Estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-default);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        /* Header */
        .header {
            background-color: var(--background-header);
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-s) var(--spacing-m);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-subtle);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }
        .logo {
            font-size: var(--h1-size);
            font-weight: var(--font-weight-bold);
            color: var(--primary-blue);
        }
        /* Contenedor principal */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--spacing-m) var(--spacing-gutter);
        }
        /* Layout principal */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: var(--spacing-xl);
            align-items: start;
        }
        /* ===== MODIFICADO: Tarjetas de resumen (KPIs) con estilo del calendario ===== */
        .kpi-section {
            margin-bottom: var(--spacing-xl);
        }
        .kpi-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-m);
        }
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            padding-bottom: var(--spacing-s);
        }
        .kpi-card {
            background-color: var(--background-card);
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-default);
            text-align: center;
            box-shadow: var(--shadow-subtle);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .kpi-card.total {
            background-color: var(--primary-blue);
            color: var(--text-light);
        }
        .kpi-card.en-tramite {
            border-left: 4px solid var(--primary-blue);
        }
        .kpi-card.finalizado {
            border-left: 4px solid var(--status-success);
        }
        .kpi-card.en-alzada {
            border-left: 4px solid var(--status-warning);
        }
        .kpi-card.archivado {
            border-left: 4px solid var(--secondary-dark-gray);
        }
        .kpi-number {
            font-size: 24px;
            font-weight: var(--font-weight-bold);
            margin-bottom: 4px;
        }
        .kpi-card.total .kpi-number {
            color: var(--text-light);
        }
        .kpi-label {
            font-size: 12px;
            font-weight: var(--font-weight-regular);
            text-transform: uppercase;
        }
        .kpi-card.total .kpi-label {
            color: var(--text-light);
        }
        /* Filtros */
        .filters-section {
            background-color: var(--background-card);
            padding: var(--spacing-m);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-subtle);
        }
        .filters-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-m);
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-label {
            display: block;
            font-size: var(--body-regular-size);
            margin-bottom: var(--spacing-xs);
            font-weight: var(--font-weight-semibold);
        }
        .input, .dropdown {
            border: 1px solid var(--border-default);
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s);
            background-color: var(--background-default);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
            width: 100%;
            transition: border-color 0.2s;
        }
        .input:focus, .dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        /* Botones de acci칩n */
        .action-buttons {
            display: flex;
            gap: var(--spacing-s);
            margin-top: var(--spacing-m);
            flex-wrap: wrap;
        }
        .button {
            background-color: var(--primary-blue);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s) var(--spacing-m);
            font-size: var(--body-regular-size);
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .button:hover {
            opacity: 0.9;
        }
        .button-success {
            background-color: #1e7e34;
        }
        .button-secondary {
            background-color: var(--secondary-dark-gray);
        }
        .button-danger {
            background-color: var(--status-danger);
        }
        /* Tabla de datos */
        .table-section {
            background-color: var(--background-card);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }
        .table-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            padding: var(--spacing-m);
            background-color: var(--background-table-header);
            border-bottom: 1px solid var(--border-default);
        }
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        .data-table th {
            background-color: var(--background-table-header);
            font-weight: var(--font-weight-semibold);
            border-bottom: 2px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--caption-size);
            text-transform: uppercase;
        }
        .data-table td {
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover td {
            background-color: var(--secondary-gray);
        }
        /* Estilos para prioridad */
        .prioridad-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
        }
        .prioridad-baja { background-color: var(--status-success); }
        .prioridad-media { background-color: var(--status-warning); }
        .prioridad-alta { background-color: var(--status-danger); }
        .prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        /* NUEVO: Estilos para prioridad en texto */
        .prioridad-texto {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .prioridad-texto.alta { 
            background-color: rgba(220, 53, 69, 0.1); 
            color: var(--status-danger); 
            border: 2px solid var(--status-danger);
        }
        .prioridad-texto.media { 
            background-color: rgba(255, 193, 7, 0.1); 
            color: var(--status-warning); 
            border: 2px solid var(--status-warning);
        }
        .prioridad-texto.baja { 
            background-color: rgba(40, 167, 69, 0.1); 
            color: var(--status-success); 
            border: 2px solid var(--status-success);
        }
        .prioridad-texto.ninguna { 
            background-color: rgba(108, 117, 125, 0.1); 
            color: var(--secondary-dark-gray); 
            border: 2px solid var(--secondary-dark-gray);
        }
        /* Sidebar - NUEVO: Estilos para el panel de Eventos de Hoy */
        .sidebar {
            background: var(--background-card);
            border-radius: var(--border-radius-default);
            box-shadow: var(--shadow-subtle);
            padding: var(--spacing-m);
            position: sticky;
            top: var(--spacing-m);
        }
        .sidebar h2 {
            margin: 0 0 var(--spacing-m);
            font-size: var(--h2-size);
            color: var(--primary-blue);
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: var(--spacing-xs);
        }
        .group {
            margin-bottom: var(--spacing-m);
        }
        .event {
            display: flex;
            gap: var(--spacing-s);
            align-items: flex-start;
            background: #f0f4f9;
            border-left: 4px solid var(--primary-blue);
            padding: var(--spacing-s);
            border-radius: var(--border-radius-default);
            margin: var(--spacing-xs) 0;
        }
        .event .when {
            font-weight: var(--font-weight-semibold);
        }
        .k {
            color: var(--text-secondary);
        }
        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--primary-light-blue);
            font-size: 0.75rem;
            margin-left: 6px;
        }
        /* NUEVO: Estilos para el panel de Eventos de Hoy */
        .eventos-hoy {
            margin-bottom: 10px;
        }
        .evento-titulo {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid;
        }
        .evento-audiencias { color: var(--color-audiencias); border-color: var(--color-audiencias); }
        .evento-vencimientos { color: var(--color-vencimientos); border-color: var(--color-vencimientos); }
        .evento-gesell { color: var(--color-gesell); border-color: var(--color-gesell); }
        .evento-recursos { color: var(--color-recursos); border-color: var(--color-recursos); }
        .evento-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid;
            transition: all 0.2s;
        }
        .evento-item-audiencias { border-left-color: var(--color-audiencias); }
        .evento-item-vencimientos { border-left-color: var(--color-vencimientos); }
        .evento-item-gesell { border-left-color: var(--color-gesell); }
        .evento-item-recursos { border-left-color: var(--color-recursos); }
        .evento-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        .evento-numero {
            font-weight: bold;
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
        }
        .evento-numero:hover {
            color: var(--primary-dark-blue);
        }
        .evento-hora {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .evento-vacio {
            font-style: italic;
            color: var(--text-secondary);
            padding: 6px 8px;
        }
        /* Paginaci칩n */
        #paginacion-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-m);
            margin-top: var(--spacing-m);
            background: var(--background-card);
            border-radius: var(--border-radius-default);
            box-shadow: var(--shadow-subtle);
        }
        #paginacion-container .page-info {
            font-size: var(--body-regular-size);
            color: var(--text-secondary);
            font-weight: var(--font-weight-semibold);
        }
        #paginacion-container .nav-buttons {
            display: flex;
            gap: var(--spacing-s);
        }
        /* MODALES - Estilos de index.html */
        #modal, #modalVer, #alertModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        #modal .content, #modalVer .content, #alertModal .content {
            background: #fff;
            border-radius: 16px;
            max-width: 980px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: fadeIn .25s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            position: sticky;
            top: 0;
            background: var(--primary-blue);
            color: #fff;
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 16px 16px 0 0;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .modal-body {
            padding: 16px 16px 0;
            overflow-y: auto;
        }
        .controls-form {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            z-index: 5;
        }
        #formCausa .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media(max-width:900px) { 
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
        }
        #formCausa label {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 0.9rem;
            margin-bottom: 4px;
            display: block;
        }
        #formCausa input, #formCausa textarea, #formCausa select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.9rem;
            background: #fafafa;
            transition: .2s;
        }
        #formCausa input:focus, #formCausa textarea:focus, #formCausa select:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: #fff;
        }
        .counter {
            font-size: .8rem;
            color: #6b7280;
            margin-top: 4px;
        }
        #agregarNota {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4f9;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        #agregarNota label {
            font-weight: 600;
            color: var(--primary-blue);
            display: block;
            margin-bottom: 8px;
        }
        #agregarNota textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
        }
        #agregarNota button {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        #verContenido p {
            margin: .35rem 0;
            font-size: .92rem;
        }
        #verContenido strong {
            color: var(--primary-blue);
        }
        .note {
            border-left: 3px solid var(--primary-blue);
            padding: 6px;
            margin: 6px 0;
            background: #f9fbff;
            border-radius: 6px;
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .prioridad-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
        }
        .prioridad-baja { background-color: var(--status-success); }
        .prioridad-media { background-color: var(--status-warning); }
        .prioridad-alta { background-color: var(--status-danger); }
        .prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        #alertModal .content {
            max-width: 400px;
            padding: 24px;
            text-align: center;
            gap: 16px;
        }
        #alertModal h3 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 1.5rem;
        }
        #alertModal p {
            margin: 0;
            color: var(--secondary-dark-gray);
            font-size: 0.95rem;
        }
        #alertModal .actions-row {
            display: flex;
            justify-content: space-around;
            gap: 12px;
            margin-top: 20px;
        }
        #alertModal .actions-row .btn {
            flex-grow: 1;
        }
        .alert-danger { background: var(--status-danger); color: white; }
        .alert-success { background: var(--status-success); color: white; }
        /* MODIFICACIONES PARA LA ALERTA FLOTANTE */
        .floating-alert {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--status-danger);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            max-width: 400px;
            text-align: center;
            font-size: 1rem;
        }
        .floating-alert.success {
            background-color: var(--status-success);
        }
        .floating-alert.show {
            opacity: 1;
            visibility: visible;
            top: 20px;
        }
        .audiencias-container {
            margin-bottom: 10px;
        }
        .audiencia-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .audiencia-item input {
            flex: 1;
        }
        .btn-eliminar-audiencia {
            background: var(--status-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-audiencia {
            background: var(--status-success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        /* Estilos para el formulario con pesta침as */
        .tabs-container {
            margin-bottom: 15px;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-button {
            background: #f0f0f0;
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-button.active {
            background: var(--primary-blue);
            color: #fff;
            position: relative;
            bottom: -2px;
            border-bottom: 2px solid var(--primary-blue);
        }
        .tab-content {
            padding: 15px 0;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-content .field:not(:last-child) {
            margin-bottom: 10px;
        }
        /* NUEVOS ESTILOS PARA LA VALIDACI칍N */
        .field.error input,
        .field.error textarea,
        .field.error select {
            border-color: var(--status-danger);
            background-color: #ffeef0;
        }
        .field .error-message {
            color: var(--status-danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        .field.error .error-message {
            display: block;
        }
        .field {
            margin-bottom: 15px;
        }
        /* Resaltado de prioridad en la vista detallada */
        #verContenido .prioridad-destacada {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            padding: 12px;
            border-radius: 12px;
            color: #fff;
        }
        .prioridad-destacada h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .prioridad-destacada .fa-exclamation-triangle {
            font-size: 1.5rem;
        }
        .prioridad-destacada.prioridad-baja { background-color: var(--status-success); }
        .prioridad-destacada.prioridad-media { background-color: var(--status-warning); }
        .prioridad-destacada.prioridad-alta { background-color: var(--status-danger); }
        .prioridad-destacada.prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        /* Estilos para el historial de notas */
        .notes-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .notes-history h4 {
            margin: 0 0 10px;
            color: var(--primary-blue);
            font-size: 1rem;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 5px;
        }
        .note-item {
            background: #f8f8f8;
            border-left: 4px solid var(--primary-blue);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--secondary-dark-gray);
            margin-bottom: 5px;
        }
        .note-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        /* Estilos para impresi칩n - OCULTAR BOTONES Y ACCIONES */
        @media print {
            .button, .actions, .action-buttons, .controls-form,
            #btnNuevo, #btnPrintListado, #btnPrintFechas, #btnPrintForm,
            #btnPrintRegistro, #btnCerrarVer, #btnAgregarNota, #btnVerLineaTiempo,
            #btnPrintTodos, #btnPrintFiltrado,
            .fa-solid, .fas, .far, .fa, .fa-eye, .fa-pen, .fa-trash, .fa-plus,
            .fa-save, .fa-print, .fa-xmark, .fa-check, .fa-arrow-left, .fa-arrow-right,
            .fa-exclamation-triangle, .fa-timeline, .fa-file-pen,
            .btn-eliminar-audiencia, .btn-audiencia, .floating-alert,
            .prioridad-destacada, .tabs-nav, .tab-button {
                display: none !important;
            }
            .header, .filters-section, .sidebar, .pagination-container {
                display: none !important;
            }
            body, .container, .main-layout, .main {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            .table-section, .kpi-section, .modal .content, #modalVer .content {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            .data-table {
                min-width: 100% !important;
            }
            .kpi-cards {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }
            .prioridad-pill {
                color: #000 !important;
                background-color: transparent !important;
                border: 1px solid #000 !important;
            }
            /* Estilos espec칤ficos para imprimir el formulario */
            .tab-content {
                display: block !important;
            }
            #formCausa .grid {
                display: table !important;
                width: 100% !important;
            }
            .field {
                display: table-row !important;
                margin-bottom: 0 !important;
            }
            .field label {
                display: table-cell !important;
                padding: 8px !important;
                font-weight: bold !important;
                width: 40% !important;
                border-bottom: 1px solid #ddd !important;
            }
            .field input, .field textarea, .field select {
                display: table-cell !important;
                width: 100% !important;
                padding: 8px !important;
                border: none !important;
                border-bottom: 1px solid #ddd !important;
                background: transparent !important;
            }
            .field textarea {
                height: auto !important;
                min-height: 60px !important;
            }
            /* Estilos para prioridad en texto durante impresi칩n */
            .prioridad-texto {
                color: #000 !important;
                background-color: transparent !important;
                border: 1px solid #000 !important;
                font-weight: bold !important;
            }
        }
        /* ===== MODIFICADO: Responsive mejorado para m칩viles con KPIs del calendario ===== */
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: var(--spacing-s);
            }
            .main-layout {
                grid-template-columns: 1fr;
                gap: var(--spacing-m);
            }
            .sidebar {
                position: relative;
                top: 0;
            }
            .kpi-cards {
                gap: var(--spacing-s);
            }
            .kpi-card {
                min-width: 160px;
                padding: var(--spacing-s) var(--spacing-m);
            }
            .filter-row {
                gap: var(--spacing-s);
            }
            .filter-group {
                min-width: 140px;
            }
            #modal .content, #modalVer .content {
                max-width: 95%;
            }
        }
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--spacing-s);
                text-align: center;
            }
            /* MODIFICADO: KPIs responsivos como en el calendario */
            .kpi-cards {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: space-between;
            }
            .kpi-card {
                flex: 1;
                min-width: 80px;
                padding: 10px 12px;
            }
            .filter-row {
                flex-direction: column;
            }
            .filter-group {
                min-width: auto;
            }
            #paginacion-container {
                flex-direction: column;
                gap: var(--spacing-m);
                text-align: center;
            }
            .table-title {
                padding: var(--spacing-s);
            }
            .data-table th, 
            .data-table td {
                padding: var(--spacing-s);
            }
            .action-buttons {
                flex-direction: column;
            }
            .controls-form {
                flex-direction: column;
            }
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
            /* Mejoras para m칩viles */
            .tabs-nav {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .tab-button {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            .data-table {
                min-width: 600px;
            }
            .actions {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 4px;
            }
        }
        @media (max-width: 576px) {
            .container {
                padding: var(--spacing-xs);
                width: 100%;
            }
            /* ===== CAMBIO SOLICITADO ===== */
            /* KPIs en una columna en pantallas peque침as */
            .kpi-cards {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            .kpi-card {
                /* Esto hace que ocupe el 100% del ancho */
                flex: 1 1 100%; 
                min-width: 0;
                padding: 10px 8px;
            }
            /* ===== FIN DEL CAMBIO ===== */
            .kpi-number {
                font-size: var(--h1-size);
            }
            .filters-section,
            .table-section,
            .sidebar {
                padding: var(--spacing-s);
            }
            .filters-title,
            .table-title,
            .sidebar h2 {
                font-size: var(--body-large-size);
            }
            .event {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            .group {
                margin-bottom: var(--spacing-s);
            }
            #modal .content, #modalVer .content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            .modal-header,
            .modal-body,
            .controls-form {
                padding: var(--spacing-s);
            }
            /* Mejoras espec칤ficas para m칩viles peque침os */
            .filter-group {
                width: 100%;
            }
            .button {
                width: 100%;
                justify-content: center;
            }
            .tab-button {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            .table-wrap {
                margin: 0 -8px;
                padding: 0 8px;
            }
            .data-table {
                min-width: 100%;
            }
            .prioridad-pill {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            .actions .button {
                width: 100%;
                font-size: 0.85rem;
            }
            .floating-alert {
                max-width: 90%;
                font-size: 0.9rem;
                padding: 10px 15px;
            }
        }
        /* Estilos para pantallas muy peque침as (menos de 360px) */
        @media (max-width: 360px) {
            .container {
                padding: 4px;
            }
            /* La regla de 576px ya cubre esto, pero la dejamos por si acaso */
            .kpi-card {
                flex: 1 1 100%;
                padding: 10px;
            }
            .filters-section,
            .table-section,
            .sidebar {
                padding: 8px;
            }
            .tab-button {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            .data-table th, 
            .data-table td {
                padding: 6px;
                font-size: 0.8rem;
            }
            .button {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="floating-alert" id="floating-alert"></div>
    <header class="header">
        <div class="header-content">
            <button id="btnNuevo" class="button">
                <i class="fas fa-plus"></i> Nuevo Expediente
            </button>
        </div>
    </header>
    <main class="container">
        <div class="main-layout">
            <div class="main">
                <section class="kpi-section">
                    <h2 class="kpi-title">Resumen de Expedientes</h2>
                    <div class="kpi-cards" id="kpiCards">
                        <div class="loading">Cargando datos...</div>
                    </div>
                </section>
                <section class="filters-section">
                    <h2 class="filters-title">Filtros de B칰squeda</h2>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label" for="buscador">B칰squeda</label>
                            <input type="text" id="buscador" class="input" placeholder="游댌 Buscar...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroTipoProceso">Tipo de Proceso</label>
                            <select id="filtroTipoProceso" class="dropdown">
                                <option value="">Tipo de Proceso (todos)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroIntervencion">Intervenci칩n</label>
                            <select id="filtroIntervencion" class="dropdown">
                                <option value="">Intervenci칩n (todas)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroEstado">Estado</label>
                            <select id="filtroEstado" class="dropdown">
                                <option value="">Estado (todos)</option>
                                <option>En tr치mite</option><option>Finalizado</option><option>En Alzada</option><option>Archivado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroUsuario">Usuario</label>
                            <select id="filtroUsuario" class="dropdown">
                                <option value="">Usuario (todos)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroPrioridad">Prioridad</label>
                            <select id="filtroPrioridad" class="dropdown">
                                <option value="">Prioridad (todas)</option>
                                <option value="Ninguna">Ninguna</option>
                                <option value="Baja">Baja</option>
                                <option value="Media">Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <!-- NUEVO: Filtro para eventos y fechas -->
                        <div class="filter-group">
                            <label class="filter-label" for="filtroEventos">Filtrar por Evento</label>
                            <select id="filtroEventos" class="dropdown">
                                <option value="">Todos los eventos</option>
                                <option value="audiencias">Audiencias</option>
                                <option value="gesell">C치mara Gesell</option>
                                <option value="vencimientos">Vencimientos</option>
                                <option value="recursos">Recursos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroFechaDesde">Fecha Desde</label>
                            <input type="date" id="filtroFechaDesde" class="input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="filtroFechaHasta">Fecha Hasta</label>
                            <input type="date" id="filtroFechaHasta" class="input">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="btnPrintTodos" class="button button-success">
                            <i class="fas fa-print"></i> Imprimir Todos
                        </button>
                        <button id="btnPrintFiltrado" class="button button-success">
                            <i class="fas fa-print"></i> Imprimir Filtrado
                        </button>
                    </div>
                </section>
                <section class="table-section">
                    <h2 class="table-title">Expedientes Judiciales</h2>
                    <div class="table-wrap">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>N춿</th>
                                    <th>Car치tula</th>
                                    <th>Tipo</th>
                                    <th>Juzgado</th>
                                    <th>Usuario</th>
                                    <th>Estado</th>
                                    <th>Prioridad</th>
                                    <th>Registro</th>
                                    <th>Pr칩x. Evento</th>
                                    <th class="no-print">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyCausas">
                                <tr>
                                    <td colspan="10">Cargando expedientes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <div id="paginacion-container"></div>
            </div>
            <!-- NUEVO: Panel de Eventos de Hoy -->
            <aside class="sidebar">
                <h2>游늰 Eventos de Hoy</h2>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-audiencias">Audiencias</div>
                    <div id="listAudHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-gesell">C치mara Gesell</div>
                    <div id="listGesellHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-vencimientos">Vencimientos</div>
                    <div id="listVencHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-recursos">Recursos</div>
                    <div id="listRecursosHoy"></div>
                </div>
            </aside>
        </div>
    </main>
    <div id="modal">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-file-pen"></i>
                <h2 id="tituloForm" style="margin:0;">Nuevo Expediente</h2>
            </div>
            <div class="modal-body">
                <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o edici칩n">
                    <input type="hidden" id="editId" />
                    <div class="tabs-container">
                        <div class="tabs-nav">
                            <button type="button" class="tab-button active" data-tab="tab1">Datos Principales</button>
                            <button type="button" class="tab-button" data-tab="tab2">Fechas y Vencimientos</button>
                            <button type="button" class="tab-button" data-tab="tab3">Recursos</button>
                            <button type="button" class="tab-button" data-tab="tab4">Observaciones</button>
                        </div>
                        <div id="tab1" class="tab-content active">
                            <div class="field">
                                <label for="numCausa">N춿 Expediente *</label>
                                <input id="numCausa" required autocomplete="off" />
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="caratula">Car치tula Completa *</label>
                                <textarea id="caratula" rows="2" required></textarea>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="tipoProceso">Tipo de Proceso *</label>
                                <select id="tipoProceso" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="juzgado">Juzgado *</label>
                                <select id="juzgado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="prioridad">Prioridad *</label>
                                <select id="prioridad" required>
                                    <option value="Ninguna"><strong>Ninguna</strong> (gris)</option>
                                    <option value="Baja"><strong>Baja</strong> (verde)</option>
                                    <option value="Media"><strong>Media</strong> (naranja)</option>
                                    <option value="Alta"><strong>Alta</strong> (roja)</option>
                                </select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="usuarioAsignado">Usuario Asignado *</label>
                                <select id="usuarioAsignado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="estado">Estado del Proceso</label>
                                <select id="estado"><option>En tr치mite</option><option>Finalizado</option><option>Archivado</option><option>En Alzada</option></select>
                            </div>
                            <div class="field">
                                <label for="intervencion">Intervenci칩n</label>
                                <select id="intervencion">
                                    <option>Ministerio Principal</option><option>Ministerio Complementario</option><option>Patrocinante Actor</option>
                                    <option>Patrocinante Demandado</option><option>Patrocinante Tercero</option><option value="Defensor de Ausente">Defensor de Ausente</option><option>Patrocinante presunto incapaz</option></option>
                                    <option value="Defensor Oficial Asesor Letrado">Asistencia Letrada del incapaz</option><option>Ministerio P칰blico del incapaz</option><option>Ministerio P칰blico en turno Abril</option><option>Ministerio P칰blico en turno Agosto</option><option>Ministerio P칰blico en turno Diciembre</option><option>Tutor Ad Litem</option><option>Defensor Oficial Art 329 CPCC</option><option>Defensor Oficial Art 626 CPCC</option>   
                                </select>
                            </div>
                            <div class="field">
                                <label for="datosNnya">Datos de NNyA (m치x. 500 palabras)</label>
                                <textarea id="datosNnya" disabled></textarea><div class="counter" id="counterNnya" style="display:none">0/500</div>
                            </div>
                        </div>
                        <div id="tab2" class="tab-content">
                            <div class="field"><label for="fechaInicio">Fecha de Inicio</label><input type="date" id="fechaInicio" /></div>
                            <div class="field"><label for="fechaPase">Fecha de Pase</label><input type="datetime-local" id="fechaPase" /></div>
                            <div class="field"><label for="vencimiento">Vencimiento</label><input type="datetime-local" id="vencimiento" /></div>
                            <div class="field">
                                <label for="audiencias">Audiencias se침aladas</label>
                                <div id="audiencias-container" class="audiencias-container"></div>
                                <button type="button" id="btnAgregarAudiencia" class="btn-audiencia"><i class="fa fa-plus"></i> Agregar Audiencia</button>
                            </div>
                            <div class="field">
                                <label for="audienciaGesell">Audiencia en C치mara Gesell</label>
                                <div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="habilitarAudienciaGesell" /><span>Habilitar</span></div>
                                <input type="datetime-local" id="audienciaGesell" disabled />
                            </div>
                            <div class="field">
                                <label for="nnyaGesell">NNyA en Gesell (m치x. 400 palabras)</label>
                                <textarea id="nnyaGesell" disabled></textarea><div class="counter" id="counterNnyaGesell" style="display:none">0/400</div>
                            </div>
                        </div>
                        <div id="tab3" class="tab-content">
                            <div class="field">
                                <label for="recursos">Recursos Interpuestos</label>
                                <select id="recursos"><option value="">Seleccione un recurso</option><option>Apelaci칩n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici칩n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                            </div>
                            <div id="recursos-opcionales" style="display:none;">
                                <div class="field">
                                    <label for="recursosContestacion">Recursos Contestaci칩n</label>
                                    <select id="recursosContestacion"><option value="">Seleccione un recurso</option><option>Apelaci칩n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici칩n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                                </div>
                                <div class="field">
                                    <label for="estadoRecursos">Estado de Recursos</label>
                                    <select id="estadoRecursos"><option value="">Seleccione un estado</option><option>Pendiente</option><option>En tr치mite</option><option>Resuelto</option><option>Rechazado</option></select>
                                </div>
                                <div class="field">
                                    <label for="vencimientoRecursos">Vencimiento de Recursos</label>
                                    <input type="datetime-local" id="vencimientoRecursos" />
                                </div>
                            </div>
                        </div>
                        <div id="tab4" class="tab-content">
                            <div class="field">
                                <label for="observaciones">Observaciones (m치x. 1000 palabras)</label>
                                <textarea id="observaciones" rows="5"></textarea><div class="counter" id="counter">0/1000</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="controls-form">
                <button class="button button-success" type="button" id="btnGuardar"><i class="fa fa-save"></i>Guardar</button>
            </div>
        </div>
    </div>
    <div id="modalVer">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-eye"></i>
                <h2 style="margin:0;">Detalle del Expediente</h2>
            </div>
            <div class="modal-body">
                <div id="verContenido"></div>
                <div id="agregarNota">
                    <label for="notaBitacora">Agregar Nota de Seguimiento:</label>
                    <textarea id="notaBitacora" placeholder="Escribe aqu칤 la nota..."></textarea>
                    <button id="btnAgregarNota" class="button"><i class="fa fa-plus"></i> Guardar Nota</button>
                </div>
                <div class="notes-history">
                    <h4>Historial de Notas</h4>
                    <div id="historialNotas"></div>
                </div>
            </div>
            <div class="controls-form" style="justify-content:flex-end;">
                <button id="btnCerrarVer" class="button button-secondary"><i class="fa fa-xmark"></i>Cerrar</button>
                <button id="btnPrintRegistro" class="button button-success"><i class="fa fa-print"></i>Imprimir Registro</button>
            </div>
        </div>
    </div>
    <div id="alertModal">
        <div class="content">
            <h3 id="alertTitle"></h3>
            <p id="alertMessage"></p>
            <div class="actions-row">
                <button id="btnAlertOK" class="button alert-success"><i class="fa fa-check"></i> OK</button>
            </div>
        </div>
    </div>
    <script>
        // ===== CONFIGURACI칍N DE FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.appspot.com",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };
        // ===== INICIALIZACI칍N DE FIREBASE =====
        // Verificar si Firebase ya est치 inicializado
        let app;
        try {
            app = firebase.app();
            console.log("Firebase ya est치 inicializado");
        } catch (e) {
            console.log("Inicializando Firebase...");
            app = firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        // ===== VARIABLES GLOBALES =====
        let modo = "nuevo"; // Variable global para el modo (nuevo/editar)
        let datosCache = [];
        let paginaActual = 1;
        let datosFiltrados = [];
        let causaActualId = null;
        let unsubCausas = null;
        let usuariosCache = [];
        let juzgadosPorTipoCache = {};
        let kpisData = {};
        // ===== CONSTANTES Y CONFIGURACIONES =====
        const recordsPerPage = 10;
        const intervencionOptions = [
            "Ministerio Principal", "Ministerio Complementario", "Patrocinante Actor",
            "Patrocinante Demandado", "Patrocinante Tercero", "Defensor de Ausente",
            "Patrocinante presunto incapaz", "Asesor Letrado", "Ministerio P칰blico del incapaz",
            "Ministerio P칰blico en turno Abril", "Ministerio P칰blico en turno Agosto",
            "Ministerio P칰blico en turno Diciembre", "Asistencia Letrada del incapaz","Tutor Ad Litem","Defensor Oficial Art 329 CPCC", "Defensor Oficial Art 626 CPCC"   
        ];
        // ===== SELECTORES DEL DOM =====
        const $ = (id) => document.getElementById(id);
        const tbody = $("tbodyCausas");
        const modal = $("modal");
        const modalVer = $("modalVer");
        const verContenido = $("verContenido");
        const tituloForm = $("tituloForm");
        const editId = $("editId");
        const buscador = $("buscador");
        const filtroEstado = $("filtroEstado");
        const filtroUsuario = $("filtroUsuario");
        const filtroPrioridad = $("filtroPrioridad");
        const filtroIntervencion = $("filtroIntervencion");
        const filtroTipoProceso = $("filtroTipoProceso");
        const filtroEventos = $("filtroEventos");
        const filtroFechaDesde = $("filtroFechaDesde");
        const filtroFechaHasta = $("filtroFechaHasta");
        const notaBitacora = $("notaBitacora");
        const historialNotas = $("historialNotas");
        const btnAgregarNota = $("btnAgregarNota");
        const listAudHoy = $("listAudHoy");
        const listGesellHoy = $("listGesellHoy");
        const listVencHoy = $("listVencHoy");
        const listRecursosHoy = $("listRecursosHoy");
        const floatingAlert = $("floating-alert");
        const audienciasContainer = $("audiencias-container");
        const btnAgregarAudiencia = $("btnAgregarAudiencia");
        const alertModal = $("alertModal");
        const alertTitle = $("alertTitle");
        const alertMessage = $("alertMessage");
        const btnAlertOK = $("btnAlertOK");
        // Selectores del formulario
        const selTipo = $("tipoProceso"), selJuz = $("juzgado"), selUsu = $("usuarioAsignado"), selPrioridad = $("prioridad");
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        // ===== FUNCIONES UTILITARIAS =====
        const toDate = (v) => v?.toDate ? v.toDate() : (v?.seconds ? new Date(v.seconds*1000) : (v ? new Date(v) : null));
        function formatearFecha(d, conHora = false) {
            const fecha = toDate(d);
            if (!fecha || isNaN(fecha)) return "";
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const a침o = fecha.getFullYear();
            if (!conHora) {
                return `${dia}/${mes}/${a침o}`;
            }
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${a침o} ${horas}:${minutos}`;
        }
        const prioridadClase = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "prioridad-alta";
            if(p === "media") return "prioridad-media";
            if(p === "baja") return "prioridad-baja";
            return "prioridad-ninguna";
        };
        const prioridadClaseTexto = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "alta";
            if(p === "media") return "media";
            if(p === "baja") return "baja";
            return "ninguna";
        };
        // NUEVA FUNCI칍N: Obtener pr칩ximo evento
        function obtenerProximoEvento(causa) {
            const eventos = [];
            // Audiencias
            if (Array.isArray(causa.audiencias)) {
                causa.audiencias.forEach(aud => {
                    const fecha = toDate(aud);
                    if (fecha) {
                        eventos.push({ tipo: "Audiencia", fecha: fecha });
                    }
                });
            }
            // C치mara Gesell
            if (causa.audienciaGesell) {
                const fecha = toDate(causa.audienciaGesell);
                if (fecha) {
                    eventos.push({ tipo: "Gesell", fecha: fecha });
                }
            }
            // Vencimiento
            if (causa.vencimiento) {
                const fecha = toDate(causa.vencimiento);
                if (fecha) {
                    eventos.push({ tipo: "Vencimiento", fecha: fecha });
                }
            }
            // Vencimiento de Recursos
            if (causa.vencimientoRecursos) {
                const fecha = toDate(causa.vencimientoRecursos);
                if (fecha) {
                    eventos.push({ tipo: "Recurso", fecha: fecha });
                }
            }
            if (eventos.length === 0) return null;
            // Encontrar el evento m치s pr칩ximo
            eventos.sort((a, b) => a.fecha - b.fecha);
            return eventos[0];
        }
        // ===== FUNCIONES DE DATOS =====
        async function cargarUsuarios() {
            try {
                console.log("Cargando usuarios...");
                const snapshot = await db.collection("usuarios").get();
                usuariosCache = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombreCompleto) {
                        usuariosCache.push(data.nombreCompleto);
                    }
                });
                usuariosCache.sort((a, b) => a.localeCompare(b));
                console.log("Usuarios cargados:", usuariosCache.length);
            } catch (e) {
                console.error("Error al cargar usuarios:", e);
                mostrarAlertaFlotante("Error al cargar usuarios", 'danger');
            }
        }
        async function cargarJuzgados() {
            try {
                console.log("Cargando juzgados...");
                const snapshot = await db.collection("juzgados").get();
                juzgadosPorTipoCache = {};
                snapshot.forEach(doc => {
                    const { tipo, nombre } = doc.data();
                    if (tipo && nombre) {
                        if (!juzgadosPorTipoCache[tipo]) {
                            juzgadosPorTipoCache[tipo] = [];
                        }
                        juzgadosPorTipoCache[tipo].push(nombre);
                    }
                });
                Object.keys(juzgadosPorTipoCache).forEach(tipo => {
                    juzgadosPorTipoCache[tipo].sort((a, b) => a.localeCompare(b));
                });
                console.log("Juzgados cargados:", Object.keys(juzgadosPorTipoCache).length);
            } catch (e) {
                console.error("Error al cargar juzgados:", e);
                mostrarAlertaFlotante("Error al cargar juzgados", 'danger');
            }
        }
        // ===== FUNCIONES DE INTERFAZ =====
        function poblarTiposProceso() {
            const selTipo = $("tipoProceso");
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            selTipo.innerHTML = '<option value="">Seleccione un tipo</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }
        function poblarFiltroTiposProceso() {
            const current = filtroTipoProceso.value;
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            filtroTipoProceso.innerHTML = '<option value="">Tipo de Proceso (todos)</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
            if (current) filtroTipoProceso.value = current;
        }
        function poblarFiltroIntervencion() {
            const current = filtroIntervencion.value;
            filtroIntervencion.innerHTML = '<option value="">Intervenci칩n (todas)</option>' + 
                intervencionOptions.map(i => `<option value="${i}">${i}</option>`).join('');
            if (current) filtroIntervencion.value = current;
        }
        function poblarJuzgadosPorTipo(tipoSeleccionado) {
            const selJuz = $("juzgado");
            const juzgados = juzgadosPorTipoCache[tipoSeleccionado] || [];
            selJuz.innerHTML = '<option value="">Seleccione un juzgado</option>' + 
                juzgados.map(j => `<option value="${j}">${j}</option>`).join('');
        }
        function poblarSelectUsuarios() {
            const selUsu = $("usuarioAsignado");
            selUsu.innerHTML = '<option value="">Seleccione un usuario</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
        }
        function poblarFiltroUsuarios() {
            const current = filtroUsuario.value; 
            filtroUsuario.innerHTML = '<option value="">Usuario (todos)</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
            if (current) filtroUsuario.value = current;
        }
        // ===== FUNCIONES PRINCIPALES =====
        function suscribirCausas() {
            if (unsubCausas) unsubCausas();
            console.log("Suscribiendo a cambios en causas...");
            unsubCausas = db.collection("causas").orderBy("fechaRegistro", "desc").onSnapshot(
                snap => {
                    console.log("Datos recibidos:", snap.size, "registros");
                    datosCache = [];
                    snap.forEach(d => {
                        datosCache.push({ id: d.id, ...d.data() });
                    });
                    handleFilterChange();
                    renderEventosHoy();
                    actualizarKPIs();
                },
                err => {
                    console.error("Error en onSnapshot causas:", err);
                    tbody.innerHTML = "<tr><td colspan='10'>Error al cargar los datos.</td></tr>";
                    mostrarAlertaFlotante("Error al cargar los expedientes", 'danger');
                }
            );
        }

        // ===== FUNCI칍N MODIFICADA: FILTRAR EN TODOS LOS CAMPOS =====
        function filtrarDatos() {
            const q = (buscador.value || "").toLowerCase();
            const est = (filtroEstado.value || "").toLowerCase();
            const usu = (filtroUsuario.value || "").toLowerCase();
            const prio = (filtroPrioridad.value || "").toLowerCase();
            const interv = (filtroIntervencion.value || "").toLowerCase();
            const tipoProc = (filtroTipoProceso.value || "").toLowerCase();
            const evento = (filtroEventos.value || "").toLowerCase();
            const fechaDesde = filtroFechaDesde.value;
            const fechaHasta = filtroFechaHasta.value;
            return datosCache.filter(d => {
                // Filtro de texto (b칰squeda): busca en TODOS los campos del objeto
                let okTexto = true;
                if (q) {
                    okTexto = false;
                    for (const [key, value] of Object.entries(d)) {
                        if (value !== null && value !== undefined) {
                            const stringValue = String(value).toLowerCase();
                            if (stringValue.includes(q)) {
                                okTexto = true;
                                break;
                            }
                        }
                    }
                }

                // Filtros exactos
                const okEstado = !est || (String(d.estado || "").toLowerCase() === est);
                const okUsuario = !usu || (String(d.usuarioAsignado || "").toLowerCase() === usu);
                const okPrioridad = !prio || (String(d.prioridad || "").toLowerCase() === prio);
                const okIntervencion = !interv || (String(d.intervencion || "").toLowerCase() === interv);
                const okTipoProceso = !tipoProc || (String(d.tipoProceso || "").toLowerCase() === tipoProc);

                // Si no hay filtro de evento ni de fechas, devolvemos los filtros b치sicos
                if (!evento && !fechaDesde && !fechaHasta) {
                    return okTexto && okEstado && okUsuario && okPrioridad && okIntervencion && okTipoProceso;
                }

                // Filtro de eventos y fechas
                let tieneEvento = !evento; // Si no hay evento seleccionado, entonces no filtra por evento
                let cumpleRangoFechas = !fechaDesde && !fechaHasta; // Si no hay fechas, no filtra por fecha

                // Si hay evento o fechas, buscamos en los eventos de la causa
                if (evento || fechaDesde || fechaHasta) {
                    let eventos = [];
                    // Audiencias
                    if (Array.isArray(d.audiencias)) {
                        d.audiencias.forEach(aud => {
                            if (aud) {
                                eventos.push({ tipo: 'audiencias', fecha: toDate(aud) });
                            }
                        });
                    }
                    // C치mara Gesell
                    if (d.audienciaGesell) {
                        eventos.push({ tipo: 'gesell', fecha: toDate(d.audienciaGesell) });
                    }
                    // Vencimientos
                    if (d.vencimiento) {
                        eventos.push({ tipo: 'vencimientos', fecha: toDate(d.vencimiento) });
                    }
                    // Vencimientos de Recursos
                    if (d.vencimientoRecursos) {
                        eventos.push({ tipo: 'recursos', fecha: toDate(d.vencimientoRecursos) });
                    }

                    // Filtrar por tipo de evento si hay
                    let eventosFiltrados = eventos;
                    if (evento) {
                        eventosFiltrados = eventos.filter(e => e.tipo === evento);
                    }

                    // Filtrar por rango de fechas si hay
                    if (fechaDesde || fechaHasta) {
                        const desde = fechaDesde ? new Date(fechaDesde) : null;
                        const hasta = fechaHasta ? new Date(fechaHasta + 'T23:59:59') : null;
                        eventosFiltrados = eventosFiltrados.filter(e => {
                            if (!e.fecha) return false;
                            const fechaEvento = new Date(e.fecha);
                            let cumpleDesde = true;
                            let cumpleHasta = true;
                            if (desde) {
                                cumpleDesde = fechaEvento >= desde;
                            }
                            if (hasta) {
                                cumpleHasta = fechaEvento <= hasta;
                            }
                            return cumpleDesde && cumpleHasta;
                        });
                    }

                    // Si hay evento, debe tener al menos un evento del tipo y que cumpla el rango
                    tieneEvento = !evento || eventosFiltrados.length > 0;
                    // Si hay fechas, debe tener al menos un evento que cumpla el rango (y el tipo si hay)
                    cumpleRangoFechas = eventosFiltrados.length > 0 || (!fechaDesde && !fechaHasta);
                }

                return okTexto && okEstado && okUsuario && okPrioridad && okIntervencion && okTipoProceso && tieneEvento && cumpleRangoFechas;
            });
        }

        const handleFilterChange = () => {
            datosFiltrados = filtrarDatos();
            paginaActual = 1;
            renderTablaPaginada();
            actualizarKPIs();
        };
        const renderTablaPaginada = () => {
            const startIndex = (paginaActual - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const dataToRender = datosFiltrados.slice(startIndex, endIndex);
            renderTablas(dataToRender);
            renderPaginacion(datosFiltrados.length, dataToRender.length);
        };
        function accionesHTML(id){
            return `<button class="button ver-detalles" data-id="${id}" title="Ver"><i class="fa fa-eye"></i></button>
                    <button class="button button-secondary editar-detalles" data-id="${id}" title="Editar"><i class="fa fa-pen"></i></button>`;
        }
        function renderTablas(data){
            tbody.innerHTML = data.length ? "" : "<tr><td colspan='10'>No hay registros</td></tr>";
            data.forEach(d=>{
                const proxEvento = obtenerProximoEvento(d);
                let proxEventoHTML = "";
                if (proxEvento) {
                    proxEventoHTML = `${proxEvento.tipo}<br><small>${formatearFecha(proxEvento.fecha, true)}</small>`;
                }
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${d.numCausa||""}</td>
                        <td>${d.caratula||""}</td>
                        <td>${d.tipoProceso||""}</td>
                        <td>${d.juzgado||""}</td>
                        <td>${d.usuarioAsignado||""}</td>
                        <td>${d.estado||""}</td>
                        <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad||"Ninguna"}</span></td>
                        <td>${formatearFecha(d.fechaRegistro, false)}</td>
                        <td>${proxEventoHTML}</td>
                        <td class="actions">${accionesHTML(d.id)}</td>
                    </tr>`);
            });
            document.querySelectorAll(".ver-detalles").forEach(b=>b.onclick=()=>abrirVer(b.dataset.id));
            document.querySelectorAll(".editar-detalles").forEach(b=>b.onclick=()=>abrirEditar(b.dataset.id));
        }
        function renderPaginacion(totalRecords, recordsOnPage) {
            const container = $("paginacion-container");
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            container.style.display = totalPages > 1 ? "flex" : "none";
            container.innerHTML = `
                <div class="page-info">
                    P치gina ${paginaActual} de ${totalPages} | Mostrando ${recordsOnPage} de ${totalRecords} registros
                </div>
                <div class="nav-buttons">
                    <button id="btnPrevPage" class="button" ${paginaActual === 1 ? 'disabled' : ''}><i class="fa fa-arrow-left"></i> Anterior</button>
                    <button id="btnNextPage" class="button" ${paginaActual === totalPages ? 'disabled' : ''}>Siguiente <i class="fa fa-arrow-right"></i></button>
                </div>
            `;
            if ($("btnPrevPage")) {
                $("btnPrevPage").onclick = () => {
                    paginaActual--;
                    renderTablaPaginada();
                };
            }
            if ($("btnNextPage")) {
                $("btnNextPage").onclick = () => {
                    paginaActual++;
                    renderTablaPaginada();
                };
            }
        }
        // NUEVA FUNCI칍N: Renderizar eventos de hoy
        function renderEventosHoy() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            const eventosHoy = {
                audiencias: [],
                gesell: [],
                vencimientos: [],
                recursos: []
            };
            datosCache.forEach(d => {
                const id = d.numCausa || d.id;
                const causaId = d.id;
                // Audiencias
                if (Array.isArray(d.audiencias)) {
                    d.audiencias.forEach(aud => {
                        const fechaAud = toDate(aud);
                        if (fechaAud && fechaAud >= hoy && fechaAud < manana) {
                            eventosHoy.audiencias.push({
                                id: causaId,
                                numCausa: id,
                                fecha: fechaAud,
                                tipo: 'Audiencia'
                            });
                        }
                    });
                }
                // C치mara Gesell
                const fechaGesell = toDate(d.audienciaGesell);
                if (fechaGesell && fechaGesell >= hoy && fechaGesell < manana) {
                    eventosHoy.gesell.push({
                        id: causaId,
                        numCausa: id,
                        fecha: fechaGesell,
                        tipo: 'C치mara Gesell'
                    });
                }
                // Vencimientos
                const fechaVenc = toDate(d.vencimiento);
                if (fechaVenc && fechaVenc >= hoy && fechaVenc < manana) {
                    eventosHoy.vencimientos.push({
                        id: causaId,
                        numCausa: id,
                        fecha: fechaVenc,
                        tipo: 'Vencimiento'
                    });
                }
                // Vencimientos de Recursos
                const fechaVrec = toDate(d.vencimientoRecursos);
                if (fechaVrec && fechaVrec >= hoy && fechaVrec < manana) {
                    eventosHoy.recursos.push({
                        id: causaId,
                        numCausa: id,
                        fecha: fechaVrec,
                        tipo: 'Vencimiento de Recurso'
                    });
                }
            });
            // Funci칩n para renderizar una lista de eventos
            const renderListaEventos = (eventos, target, tipo) => {
                target.innerHTML = "";
                if (!eventos.length) {
                    target.innerHTML = `<div class="evento-vacio">No hay eventos para hoy</div>`;
                    return;
                }
                // Ordenar eventos por fecha
                eventos.sort((a, b) => a.fecha - b.fecha);
                eventos.forEach(evento => {
                    const elemento = document.createElement('div');
                    elemento.className = `evento-item evento-item-${tipo}`;
                    elemento.innerHTML = `
                        <span class="evento-numero" data-id="${evento.id}">${evento.numCausa}</span>
                        <span class="evento-hora">${formatearFecha(evento.fecha, true)}</span>
                    `;
                    target.appendChild(elemento);
                    // Agregar event listener al n칰mero de causa
                    const numeroCausa = elemento.querySelector('.evento-numero');
                    numeroCausa.onclick = (e) => {
                        e.preventDefault();
                        abrirVer(evento.id);
                    };
                });
            };
            // Renderizar cada tipo de evento
            renderListaEventos(eventosHoy.audiencias, listAudHoy, 'audiencias');
            renderListaEventos(eventosHoy.gesell, listGesellHoy, 'gesell');
            renderListaEventos(eventosHoy.vencimientos, listVencHoy, 'vencimientos');
            renderListaEventos(eventosHoy.recursos, listRecursosHoy, 'recursos');
        }
        function actualizarKPIs() {
            const kpiCardsContainer = $("kpiCards");
            if (datosCache.length === 0) {
                kpiCardsContainer.innerHTML = '<div class="loading">No hay datos disponibles</div>';
                return;
            }
            // Calcular KPIs
            const totalCasos = datosCache.length;
            const enTramite = datosCache.filter(c => c.estado && c.estado === 'En tr치mite').length;
            const finalizado = datosCache.filter(c => c.estado && c.estado === 'Finalizado').length;
            const enAlzada = datosCache.filter(c => c.estado && c.estado === 'En Alzada').length;
            const archivado = datosCache.filter(c => c.estado && c.estado === 'Archivado').length;
            kpisData = {
                total: totalCasos,
                enTramite: enTramite,
                finalizado: finalizado,
                enAlzada: enAlzada,
                archivado: archivado
            };
            let kpisHTML = '';
            // KPIs predefinidos con etiquetas formateadas
            const kpisConfig = [
                { key: 'total', label: 'Total de Causas', class: 'total' },
                { key: 'enTramite', label: 'En Tr치mite', class: 'en-tramite' },
                { key: 'finalizado', label: 'Finalizado', class: 'finalizado' },
                { key: 'enAlzada', label: 'En Alzada', class: 'en-alzada' },
                { key: 'archivado', label: 'Archivado', class: 'archivado' }
            ];
            // Generar tarjetas de KPIs basadas en los datos
            kpisConfig.forEach(kpi => {
                if (kpisData[kpi.key] !== undefined) {
                    kpisHTML += `
                        <div class="kpi-card ${kpi.class}">
                            <div class="kpi-number">${kpisData[kpi.key]}</div>
                            <div class="kpi-label">${kpi.label}</div>
                        </div>
                    `;
                }
            });
            kpiCardsContainer.innerHTML = kpisHTML;
        }
        // ===== FUNCIONES DE GESTI칍N DE EXPEDIENTES =====
        $("btnNuevo").onclick = ()=>{ // CORRECCI칍N: No necesita ser async
            modo = "nuevo"; 
            resetFormCausa(); 
            editId.value = ""; 
            tituloForm.textContent = "Nuevo Expediente"; 
            // await initForm(); // CORRECCI칍N: Eliminado, los listeners ya est치n
            modal.style.display = "flex"; 
        };
        function validateForm() {
            let isValid = true;
            const requiredFields = ["numCausa", "caratula", "tipoProceso", "juzgado", "prioridad", "usuarioAsignado"];
            requiredFields.forEach(id => {
                const field = $(id);
                const parent = field.closest('.field');
                if (field.value.trim() === "") {
                    parent.classList.add('error');
                    isValid = false;
                } else {
                    parent.classList.remove('error');
                }
            });
            if (modo === "nuevo") {
                const numCausa = $("numCausa").value.trim();
                const numCausaExistente = datosCache.some(d => d.numCausa === numCausa);
                const numCausaField = $("numCausa").closest('.field');
                if (numCausaExistente) {
                    numCausaField.classList.add('error');
                    numCausaField.querySelector('.error-message').textContent = "Esta causa ya se encuentra registrada.";
                    isValid = false;
                } else {
                    numCausaField.classList.remove('error');
                    numCausaField.querySelector('.error-message').textContent = "Este campo es obligatorio.";
                }
            }
            return isValid;
        }
        const mostrarAlertaPersonalizada = (titulo, mensaje) => {
            alertTitle.textContent = titulo;
            alertMessage.textContent = mensaje;
            alertModal.style.display = "flex";
        };
        btnAlertOK.onclick = () => {
            alertModal.style.display = "none";
        };
        const mostrarAlertaFlotante = (mensaje, tipo) => {
            floatingAlert.textContent = mensaje;
            floatingAlert.classList.remove('danger', 'success');
            floatingAlert.classList.add(tipo);
            floatingAlert.classList.add('show');
            setTimeout(() => {
                floatingAlert.classList.remove('show');
            }, 3000);
        };
        const guardarExpediente = async () => {
            if (!validateForm()) {
                mostrarAlertaPersonalizada("Error de Validaci칩n", "Por favor, completa los campos obligatorios.");
                return;
            }
            const datos = recolectarDatosForm();
            const btnGuardar = $("btnGuardar");
            btnGuardar.disabled = true;
            try {
                if (modo === "nuevo") {
                    await db.collection("causas").add({...datos, fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()});
                    mostrarAlertaFlotante("Se guard칩 correctamente el expediente.", 'success');
                } else {
                    await db.collection("causas").doc(editId.value).update(datos);
                    mostrarAlertaFlotante("El registro fue correctamente actualizado.", 'success');
                }
                modal.style.display = "none";
                resetFormCausa();
            } catch (e) {
                console.error(e);
                if (modo === "nuevo") {
                    mostrarAlertaFlotante("Fallo al crear el registro.", 'danger');
                } else {
                    mostrarAlertaFlotante("Fallo de actualizaci칩n del registro.", 'danger');
                }
            } finally {
                btnGuardar.disabled = false;
            }
        };
        $("btnGuardar").onclick = guardarExpediente;
        async function abrirEditar(id){
            modo = "editar"; 
            resetFormCausa(); // Resetear primero para limpiar estado
            editId.value = id; 
            tituloForm.textContent = "Editar Expediente";
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (snap.exists){
                    // await initForm(); // CORRECCI칍N: Eliminado
                    cargarDatosEnForm(snap.data());
                    modal.style.display = "flex"; 
                } else {
                    mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
                }
            }catch(e){ 
                console.error(e); 
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el registro."); 
            }
        }
        async function abrirVer(id){
            causaActualId = id;
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (!snap.exists) {
                    mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
                    return;
                }
                const d = snap.data();
                let contenidoHTML = "";
                // Mostrar prioridad en texto con colores seg칰n el nivel
                const prioridadClaseTextoVal = prioridadClaseTexto(d.prioridad);
                const prioridadTexto = `<div class="prioridad-texto ${prioridadClaseTextoVal}"><strong>Prioridad: ${d.prioridad || "Ninguna"}</strong></div>`;
                contenidoHTML += prioridadTexto;
                const etiquetas = {
                    numCausa: "N춿 Expediente", caratula: "Car치tula", tipoProceso: "Tipo de Proceso", juzgado: "Juzgado",
                    fechaInicio: "Fecha de Inicio", fechaPase: "Fecha de Pase", intervencion: "Intervenci칩n",
                    datosNnya: "Datos de NNyA", vencimiento: "Vencimiento", usuarioAsignado: "Usuario Asignado",
                    estado: "Estado", recursos: "Recursos Interpuestos",
                    recursosContestacion: "Contestaci칩n de Recursos", estadoRecursos: "Estado de Recursos",
                    vencimientoRecursos: "Vencimiento de Recursos", audienciaGesell: "Audiencia Gesell",
                    nnyaGesell: "NNyA en Gesell", observaciones: "Observaciones", fechaRegistro: "Fecha de Registro"
                };
                const ordenClaves = [
                    "numCausa", "caratula", "tipoProceso", "juzgado", "estado", "usuarioAsignado",
                    "fechaRegistro", "fechaInicio", "fechaPase", "intervencion", "datosNnya", "vencimiento",
                    "audiencias", "recursos", "recursosContestacion", "estadoRecursos", "vencimientoRecursos",
                    "audienciaGesell", "nnyaGesell", "observaciones"
                ];
                ordenClaves.forEach(k => {
                    const v = d[k];
                    if (v !== null && v !== undefined && v !== "" && k !== "prioridad") {
                        const etiqueta = etiquetas[k] || k;
                        if (k === "audiencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Audiencias:</strong></p>`;
                            v.forEach(aud => {
                                contenidoHTML += `<p style="margin-left: 20px;">${formatearFecha(aud, true)}</p>`;
                            });
                        } else if (['fechaInicio', 'fechaRegistro'].includes(k)) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, false)}</p>`;
                        } else if (v.seconds) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, true)}</p>`;
                        } else if (k !== "audiencias") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${v}</p>`;
                        }
                    }
                });
                verContenido.innerHTML = contenidoHTML;
                await cargarNotas(id);
                modalVer.style.display = "flex";
            } catch(e) {
                console.error(e);
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el detalle.");
            }
        }
        async function cargarNotas(causaId) {
            historialNotas.innerHTML = "Cargando notas...";
            try {
                const snapshot = await db.collection("causas").doc(causaId).collection("seguimiento").orderBy("fecha", "desc").get();
                if (snapshot.empty) {
                    historialNotas.innerHTML = `<p class="k">No hay notas de seguimiento.</p>`;
                    return;
                }
                historialNotas.innerHTML = "";
                snapshot.forEach(doc => {
                    const nota = doc.data();
                    const fecha = formatearFecha(nota.fecha, true);
                    const notaHTML = `
                        <div class="note-item">
                        <div class="note-meta">
                            <span>${fecha}</span>
                            <span>por: ${nota.usuario || "An칩nimo"}</span>
                        </div>
                        <div class="note-text">${nota.texto}</div>
                        </div>
                    `;
                    historialNotas.insertAdjacentHTML("beforeend", notaHTML);
                });
            } catch(e) {
                console.error("Error al cargar notas:", e);
                historialNotas.innerHTML = `<p class="k">Error al cargar notas.</p>`;
            }
        }
        async function agregarNota() {
            if (!causaActualId) return mostrarAlertaPersonalizada("Error", "No se ha seleccionado una causa.");
            const notaTexto = notaBitacora.value.trim();
            if (!notaTexto) return mostrarAlertaPersonalizada("Error", "Por favor, escribe un texto para la nota.");
            const usuario = "Usuario Actual"; 
            try {
                await db.collection("causas").doc(causaActualId).collection("seguimiento").add({
                    texto: notaTexto, fecha: firebase.firestore.FieldValue.serverTimestamp(), usuario: usuario
                });
                notaBitacora.value = "";
                cargarNotas(causaActualId);
                mostrarAlertaPersonalizada("춰칄xito!", "Nota guardada con 칠xito.");
            } catch (e) {
                console.error("Error al guardar la nota:", e);
                mostrarAlertaPersonalizada("Error", "No se pudo guardar la nota.");
            }
        }
        btnAgregarNota.onclick = agregarNota;
        $("btnCerrarVer").onclick = ()=> modalVer.style.display = "none";
        // ===== FUNCIONES DE IMPRESI칍N =====
        const printSection = (html)=>{ 
            const w = window.open("","_blank","width=900,height=700"); 
            w.document.write(`
                <html>
                    <head>
                        <title>Imprimir</title>
                        <style>
                            @media print {
                                .button, .actions, .action-buttons, .controls-form,
                                #btnNuevo, #btnPrintListado, #btnPrintFechas, #btnPrintForm,
                                #btnPrintRegistro, #btnCerrarVer, #btnAgregarNota, #btnVerLineaTiempo,
                                #btnPrintTodos, #btnPrintFiltrado,
                                .fa-solid, .fas, .far, .fa, .fa-eye, .fa-pen, .fa-trash, .fa-plus,
                                .fa-save, .fa-print, .fa-xmark, .fa-check, .fa-arrow-left, .fa-arrow-right,
                                .fa-exclamation-triangle, .fa-timeline, .fa-file-pen,
                                .btn-eliminar-audiencia, .btn-audiencia, .floating-alert,
                                .prioridad-destacada, .tabs-nav, .tab-button {
                                    display: none !important;
                                }
                                .header, .filters-section, .sidebar, .pagination-container {
                                    display: none !important;
                                }
                                body, .container, .main-layout, .main {
                                    margin: 0 !important;
                                    padding: 0 !important;
                                    width: 100% !important;
                                    max-width: 100% !important;
                                }
                                .table-section, .kpi-section, .modal .content, #modalVer .content {
                                    box-shadow: none !important;
                                    border: 1px solid #ddd !important;
                                    page-break-inside: avoid;
                                }
                                .data-table {
                                    min-width: 100% !important;
                                }
                                .kpi-cards {
                                    display: grid !important;
                                    grid-template-columns: repeat(3, 1fr) !important;
                                    gap: 10px !important;
                                }
                                .prioridad-pill {
                                    color: #000 !important;
                                    background-color: transparent !important;
                                    border: 1px solid #000 !important;
                                }
                                .actions {
                                    display: none !important;
                                }
                                /* Estilos espec칤ficos para imprimir el formulario */
                                .tab-content {
                                    display: block !important;
                                }
                                #formCausa .grid {
                                    display: table !important;
                                    width: 100% !important;
                                }
                                .field {
                                    display: table-row !important;
                                    margin-bottom: 0 !important;
                                }
                                .field label {
                                    display: table-cell !important;
                                    padding: 8px !important;
                                    font-weight: bold !important;
                                    width: 40% !important;
                                    border-bottom: 1px solid #ddd !important;
                                }
                                .field input, .field textarea, .field select {
                                    display: table-cell !important;
                                    width: 100% !important;
                                    padding: 8px !important;
                                    border: none !important;
                                    border-bottom: 1px solid #ddd !important;
                                    background: transparent !important;
                                }
                                .field textarea {
                                    height: auto !important;
                                    min-height: 60px !important;
                                }
                                /* Estilos para prioridad en texto durante impresi칩n */
                                .prioridad-texto {
                                    color: #000 !important;
                                    background-color: transparent !important;
                                    border: 1px solid #000 !important;
                                    font-weight: bold !important;
                                }
                                /* Estilos para impresi칩n del detalle */
                                #verContenido p {
                                    margin: 8px 0 !important;
                                    font-size: 14px !important;
                                    line-height: 1.4 !important;
                                }
                                #verContenido strong {
                                    color: #000 !important;
                                    font-weight: bold !important;
                                }
                                .notes-history {
                                    margin-top: 20px !important;
                                    padding-top: 20px !important;
                                    border-top: 1px solid #ddd !important;
                                }
                                .notes-history h4 {
                                    margin: 0 0 10px !important;
                                    color: #000 !important;
                                    font-size: 16px !important;
                                    border-bottom: 2px solid #000 !important;
                                    padding-bottom: 5px !important;
                                }
                                .note-item {
                                    background: #f8f8f8 !important;
                                    border-left: 4px solid #007bff !important;
                                    padding: 10px !important;
                                    margin-bottom: 10px !important;
                                    border-radius: 8px !important;
                                }
                                .note-meta {
                                    display: flex !important;
                                    justify-content: space-between !important;
                                    font-size: 12px !important;
                                    color: #6c757d !important;
                                    margin-bottom: 5px !important;
                                }
                                .note-text {
                                    font-size: 14px !important;
                                    line-height: 1.4 !important;
                                }
                            }
                        </style>
                    </head>
                    <body>${html}</body>
                </html>
            `); 
            w.document.close(); 
            w.focus(); 
            w.print(); 
        };
        function generarTablaImpresion(data, titulo) {
            let tableHTML = `
                <table border="1" style="width:100%; border-collapse:collapse; margin-top:20px;">
                    <thead>
                        <tr>
                            <th>N춿</th>
                            <th>Car치tula</th>
                            <th>Tipo</th>
                            <th>Juzgado</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Registro</th>
                            <th>Pr칩x. Evento</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach(d => {
                const proxEvento = obtenerProximoEvento(d);
                let proxEventoTexto = "";
                if (proxEvento) {
                    proxEventoTexto = `${proxEvento.tipo} ${formatearFecha(proxEvento.fecha, true)}`;
                }
                tableHTML += `
                    <tr>
                        <td>${d.numCausa||""}</td>
                        <td>${d.caratula||""}</td>
                        <td>${d.tipoProceso||""}</td>
                        <td>${d.juzgado||""}</td>
                        <td>${d.usuarioAsignado||""}</td>
                        <td>${d.estado||""}</td>
                        <td>${d.prioridad||"Ninguna"}</td>
                        <td>${formatearFecha(d.fechaRegistro, false)}</td>
                        <td>${proxEventoTexto}</td>
                    </tr>
                `;
            });
            tableHTML += `
                    </tbody>
                </table>
            `;
            return `<h2>${titulo}</h2>${tableHTML}`;
        }
        $("btnPrintTodos").onclick = ()=> { 
            const html = generarTablaImpresion(datosCache, "Listado Completo de Expedientes Judiciales");
            printSection(html); 
        };
        $("btnPrintFiltrado").onclick = ()=> { 
            const html = generarTablaImpresion(datosFiltrados, "Listado Filtrado de Expedientes Judiciales");
            printSection(html); 
        };
        $("btnPrintRegistro").onclick = ()=> {
            const contenido = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #007bff;">Detalle del Expediente</h2>
                    <div style="margin-bottom: 20px;">
                        ${verContenido.innerHTML}
                    </div>
                    <div class="notes-history">
                        <h4 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px;">Historial de Notas</h4>
                        ${historialNotas.innerHTML}
                    </div>
                </div>
            `;
            printSection(contenido);
        };
        // ===== FUNCIONES DEL FORMULARIO =====
        // Listener para las pesta침as del formulario
        tabButtons.forEach(button => {
            button.addEventListener("click", () => {
                tabButtons.forEach(btn => btn.classList.remove("active"));
                tabContents.forEach(content => content.classList.remove("active"));
                button.classList.add("active");
                const tabId = button.dataset.tab;
                $(tabId).classList.add("active");
            });
        });
        function toggleFormFields(enable) {
            const formFields = document.querySelectorAll('#formCausa input, #formCausa textarea, #formCausa select');
            formFields.forEach(field => {
                if (field.id !== 'numCausa' && field.id !== 'editId') {
                    field.disabled = !enable;
                }
            });
            $("btnGuardar").disabled = !enable;
        }
        function validarExistenciaCausa() {
            if (modo !== "nuevo") return;
            const numCausa = $("numCausa").value.trim();
            const numCausaField = $("numCausa").closest('.field');
            const numCausaExistente = datosCache.some(d => d.numCausa === numCausa);
            if (numCausaExistente) {
                numCausaField.classList.add('error');
                numCausaField.querySelector('.error-message').textContent = "Esta causa ya se encuentra registrada.";
                mostrarAlertaFlotante("Causa registrada antes, vuelva a intentar con otro numero.", 'danger');
                toggleFormFields(false);
            } else {
                numCausaField.classList.remove('error');
                numCausaField.querySelector('.error-message').textContent = "Este campo es obligatorio.";
                toggleFormFields(true);
            }
        }
        // CORRECCI칍N: Esta funci칩n ahora solo configura los listeners
        function initFormEventListeners(){
            selTipo.addEventListener("change", function() {
                poblarJuzgadosPorTipo(this.value);
            });
            $("recursos").addEventListener("change", function(){
                const recursosOpcionales = $("recursos-opcionales");
                recursosOpcionales.style.display = this.value ? "block" : "none";
            });
            // Agregar el validador en tiempo real al campo de numCausa
            $("numCausa").addEventListener("input", validarExistenciaCausa);
            $("intervencion").addEventListener("change", function(){
                const datosNnya = $("datosNnya"), contadorNnya = $("counterNnya");
                if (this.value === "Ministerio Complementario") { 
                    datosNnya.removeAttribute("disabled"); 
                    contadorNnya.style.display='block'; 
                } else { 
                    datosNnya.value = ""; 
                    datosNnya.setAttribute("disabled","true"); 
                    contadorNnya.style.display='none'; 
                }
            });
            const limitWords = (text, max)=>{ 
                const words = text.trim().split(/\s+/).filter(Boolean); 
                return words.length > max ? words.slice(0,max).join(" ") : text; 
            };
            $("observaciones").addEventListener("input", function(){ 
                this.value = limitWords(this.value, 1000); 
                $("counter").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/1000`; 
            });
            $("datosNnya").addEventListener("input", function(){ 
                this.value = limitWords(this.value, 500); 
                $("counterNnya").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/500`; 
            });
            $("nnyaGesell").addEventListener("input", function(){ 
                this.value = limitWords(this.value, 400); 
                $("counterNnyaGesell").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/400`; 
            });
            $("habilitarAudienciaGesell").addEventListener("change", function(){ 
                toggleGesell(this.checked); 
            });
        }
        function toggleGesell(enabled){ 
            const ag = $("audienciaGesell"), ng = $("nnyaGesell"); 
            if (enabled){ 
                ag.removeAttribute("disabled"); 
                ng.removeAttribute("disabled"); 
                $("counterNnyaGesell").style.display='block'; 
            } else { 
                ag.value = ""; 
                ng.value = ""; 
                ag.setAttribute("disabled","true"); 
                ng.setAttribute("disabled","true"); 
                $("counterNnyaGesell").style.display='none'; 
            } 
        }
        function resetFormCausa(){ 
            $("formCausa").reset(); 
            $("counter").textContent = "0/1000"; 
            $("counterNnya").textContent = "0/500"; 
            $("counterNnyaGesell").textContent = "0/400"; 
            selPrioridad.value = "Ninguna"; 
            audienciasContainer.innerHTML = ""; 
            agregarAudiencia();
            document.querySelectorAll('.field.error').forEach(el => el.classList.remove('error'));
            // Volver a la primera pesta침a
            tabButtons.forEach(btn => btn.classList.remove("active"));
            tabContents.forEach(content => content.classList.remove("active"));
            tabButtons[0].classList.add("active");
            tabContents[0].classList.add("active");
            $("recursos-opcionales").style.display = "none";
            // CORRECCI칍N: Asegurarse de resetear Gesell
            toggleGesell(false);
            $("habilitarAudienciaGesell").checked = false;
            toggleFormFields(true);
        }
        function recolectarDatosForm(){
            const fields = ["numCausa","caratula","tipoProceso","juzgado","fechaInicio","fechaPase","intervencion","datosNnya","vencimiento","usuarioAsignado","estado","prioridad","recursos","recursosContestacion","estadoRecursos","vencimientoRecursos","audienciaGesell","nnyaGesell","observaciones"];
            const datos = {};
            fields.forEach(id=>{ 
                const el = $(id); 
                if(!el) return; 
                if (["date","datetime-local"].includes(el.type)) { 
                    datos[id] = el.value ? new Date(el.value) : null;
                } else { 
                    datos[id] = el.value || ""; 
                } 
            });
            const audiencias = [];
            audienciasContainer.querySelectorAll('input[type="datetime-local"]').forEach(input => { 
                if (input.value) audiencias.push(new Date(input.value)); 
            });
            datos.audiencias = audiencias.length > 0 ? audiencias : null;
            return datos;
        }
        function cargarDatosEnForm(d) {
            const formatFechaParaInput = (fecha, conHora = true) => {
                if (!fecha || isNaN(fecha)) return "";
                const a침o = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                if (!conHora) {
                    return `${a침o}-${mes}-${dia}`;
                }
                const horas = String(fecha.getHours()).padStart(2, '0');
                const minutos = String(fecha.getMinutes()).padStart(2, '0');
                return `${a침o}-${mes}-${dia}T${horas}:${minutos}`;
            };
            const setVal = (id, val) => {
                const el = $(id);
                if (!el) return;
                if (val?.seconds) {
                    const fecha = toDate(val);
                    if (el.type === "date") {
                        el.value = formatFechaParaInput(fecha, false);
                    } else if (el.type === "datetime-local") {
                        el.value = formatFechaParaInput(fecha, true);
                    } else {
                        el.value = val ?? "";
                    }
                } else if (val && (el.type === "date" || el.type === "datetime-local")) {
                    // Manejar fechas que ya son strings o objetos Date
                    const fecha = toDate(val);
                    el.value = formatFechaParaInput(fecha, el.type === "datetime-local");
                }
                else {
                    el.value = val ?? "";
                }
            };
            if (d.tipoProceso) {
                selTipo.value = d.tipoProceso;
                poblarJuzgadosPorTipo(d.tipoProceso);
            }
            ["numCausa", "caratula", "tipoProceso", "juzgado", "intervencion", "datosNnya", "usuarioAsignado", "estado", "prioridad", "recursos", "recursosContestacion", "estadoRecursos", "nnyaGesell", "observaciones"].forEach(k => setVal(k, d[k]));
            ["fechaInicio", "fechaPase", "vencimiento", "vencimientoRecursos", "audienciaGesell"].forEach(k => setVal(k, d[k]));
            const hayRecursos = !!d.recursos;
            $("recursos-opcionales").style.display = hayRecursos ? "block" : "none";
            audienciasContainer.innerHTML = "";
            if (Array.isArray(d.audiencias) && d.audiencias.length > 0) {
                d.audiencias.forEach(aud => {
                    const fecha = toDate(aud);
                    if (fecha) {
                        audienciasContainer.appendChild(crearAudienciaItem(formatFechaParaInput(fecha, true)));
                    }
                });
            } else {
                agregarAudiencia();
            }
            const habilitar = !!(d.audienciaGesell || d.nnyaGesell);
            $("habilitarAudienciaGesell").checked = habilitar;
            toggleGesell(habilitar);
        }
        function crearAudienciaItem(value = "") {
            const item = document.createElement('div');
            item.className = 'audiencia-item';
            item.innerHTML = `<input type="datetime-local" value="${value}"><button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>`;
            const eliminarBtn = item.querySelector('.btn-eliminar-audiencia');
            eliminarBtn.onclick = function() { 
                if (audienciasContainer.children.length > 1) {
                    item.remove(); 
                } else {
                    mostrarAlertaPersonalizada("Error", "Debe haber al menos una audiencia"); 
                }
            };
            return item;
        }
        function agregarAudiencia() { 
            audienciasContainer.appendChild(crearAudienciaItem()); 
        }
        btnAgregarAudiencia.onclick = agregarAudiencia;
        // ===== EVENT LISTENERS GLOBALES =====
        window.addEventListener("click", e=>{ 
            if (e.target === modal) modal.style.display="none"; 
            if (e.target === modalVer) modalVer.style.display="none"; 
            if (e.target === alertModal) alertModal.style.display="none";
        });
        // Event listeners para filtros
        buscador.oninput = handleFilterChange;
        filtroEstado.onchange = handleFilterChange;
        filtroUsuario.onchange = handleFilterChange;
        filtroPrioridad.onchange = handleFilterChange;
        filtroIntervencion.onchange = handleFilterChange;
        filtroTipoProceso.onchange = handleFilterChange;
        filtroEventos.onchange = handleFilterChange;
        filtroFechaDesde.onchange = handleFilterChange;
        filtroFechaHasta.onchange = handleFilterChange;
        // ===== INICIALIZACI칍N DE LA APLICACI칍N =====
        async function initApp() {
            try {
                console.log("Inicializando aplicaci칩n...");
                // Cargar datos base (usuarios, juzgados) en paralelo
                await Promise.all([cargarUsuarios(), cargarJuzgados()]);
                // Poblar todos los filtros y selects que dependen de los datos base
                poblarFiltroUsuarios();
                poblarTiposProceso();
                poblarFiltroTiposProceso();
                poblarFiltroIntervencion();
                poblarSelectUsuarios();
                // CORRECCI칍N: Configurar los listeners del formulario UNA SOLA VEZ
                initFormEventListeners();
                // Suscribirse a los datos principales (expedientes)
                suscribirCausas();
                console.log("Aplicaci칩n inicializada correctamente");
            } catch (error) {
                console.error("Error durante la inicializaci칩n:", error);
                mostrarAlertaPersonalizada("Error de Carga", "Error al cargar los datos iniciales. Verifica la consola para m치s detalles.");
            }
        }
        // Inicializar la aplicaci칩n cuando el DOM est칠 listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>